<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Avan√ßado para Data Science</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --accent-hover: #79b8ff;
            --success: #3fb950;
            --warning: #d29922;
            --code-bg: #1a1f26;
            --border: #30363d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.7;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #1a1f26 0%, #2d333b 100%);
            border-bottom: 1px solid var(--border);
            padding: 40px 20px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, var(--accent), #a371f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Navigation */
        nav {
            background: var(--bg-secondary);
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        nav a:hover,
        nav a.active {
            background: var(--bg-tertiary);
            color: var(--accent);
        }

        /* Modules */
        .module {
            background: var(--bg-secondary);
            border-radius: 12px;
            margin: 30px 0;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .module-header {
            background: var(--bg-tertiary);
            padding: 20px 25px;
            border-bottom: 1px solid var(--border);
        }

        .module-header h2 {
            color: var(--accent);
            font-size: 1.5rem;
        }

        .module-content {
            padding: 25px;
        }

        /* Sections */
        .section {
            margin-bottom: 40px;
        }

        .section h3 {
            color: var(--text-primary);
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
            display: inline-block;
        }

        .section h4 {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin: 20px 0 10px;
        }

        p {
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        /* Code blocks */
        pre {
            background: var(--code-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
            margin: 15px 0;
            position: relative;
        }

        code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            color: #e6edf3;
        }

        p code,
        li code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Syntax highlighting */
        .keyword {
            color: #ff7b72;
        }

        .string {
            color: #a5d6ff;
        }

        .comment {
            color: #8b949e;
            font-style: italic;
        }

        .function {
            color: #d2a8ff;
        }

        .number {
            color: #79c0ff;
        }

        .class {
            color: #ffa657;
        }

        /* Exercise boxes */
        .exercise {
            background: linear-gradient(135deg, #1a2332 0%, #1a1f26 100%);
            border: 1px solid #1f6feb;
            border-left: 4px solid var(--accent);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .exercise-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .exercise-badge {
            background: var(--accent);
            color: var(--bg-primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .exercise-title {
            color: var(--text-primary);
            font-weight: 600;
        }

        .difficulty {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: auto;
        }

        .difficulty.easy {
            background: #238636;
        }

        .difficulty.medium {
            background: #9e6a03;
        }

        .difficulty.hard {
            background: #da3633;
        }

        /* Solution toggle */
        .solution {
            margin-top: 15px;
            border-top: 1px dashed var(--border);
            padding-top: 15px;
        }

        .solution-toggle {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .solution-toggle:hover {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .solution-content {
            display: none;
            margin-top: 15px;
        }

        .solution-content.show {
            display: block;
        }

        /* Tips and notes */
        .tip,
        .note,
        .warning {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .tip {
            background: rgba(63, 185, 80, 0.1);
            border-left: 4px solid var(--success);
        }

        .note {
            background: rgba(88, 166, 255, 0.1);
            border-left: 4px solid var(--accent);
        }

        .warning {
            background: rgba(210, 153, 34, 0.1);
            border-left: 4px solid var(--warning);
        }

        .tip::before {
            content: "üí° ";
        }

        .note::before {
            content: "üìù ";
        }

        .warning::before {
            content: "‚ö†Ô∏è ";
        }

        /* Lists */
        ul,
        ol {
            margin: 15px 0 15px 25px;
            color: var(--text-secondary);
        }

        li {
            margin-bottom: 8px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid var(--border);
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        td {
            color: var(--text-secondary);
        }

        tr:hover td {
            background: var(--bg-tertiary);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 50px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            nav ul {
                flex-direction: column;
                align-items: center;
            }

            .container {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>üêç Python Avan√ßado para Data Science</h1>
        <p>Apostila hands-on com teoria concisa e muitos exerc√≠cios pr√°ticos</p>
    </header>

    <nav>
        <ul>
            <li><a href="#modulo1" class="active">1. Pandas Avan√ßado</a></li>
            <li><a href="#modulo2">2. NumPy Avan√ßado</a></li>
            <li><a href="#modulo3">3. Dados em Escala</a></li>
            <li><a href="#modulo4">4. Visualiza√ß√£o</a></li>
            <li><a href="#modulo5">5. ML Pipeline</a></li>
        </ul>
    </nav>

    <div class="container">
        <!-- M√ìDULO 1: PANDAS AVAN√áADO -->
        <div class="module" id="modulo1">
            <div class="module-header">
                <h2>üìä M√≥dulo 1: Pandas Avan√ßado</h2>
            </div>
            <div class="module-content">
                <!-- 1.1 MERGE E JOIN AVAN√áADOS -->
                <div class="section">
                    <h3>1.1 Merge e Join Avan√ßados</h3>

                    <p>O <code>merge()</code> do Pandas √© extremamente poderoso. Vamos al√©m do b√°sico.</p>

                    <h4>Tipos de Merge</h4>
                    <table>
                        <tr>
                            <th>Tipo</th>
                            <th>Descri√ß√£o</th>
                            <th>SQL Equivalente</th>
                        </tr>
                        <tr>
                            <td><code>inner</code></td>
                            <td>Apenas matches em ambos</td>
                            <td>INNER JOIN</td>
                        </tr>
                        <tr>
                            <td><code>left</code></td>
                            <td>Todos da esquerda + matches</td>
                            <td>LEFT JOIN</td>
                        </tr>
                        <tr>
                            <td><code>right</code></td>
                            <td>Todos da direita + matches</td>
                            <td>RIGHT JOIN</td>
                        </tr>
                        <tr>
                            <td><code>outer</code></td>
                            <td>Todos de ambos</td>
                            <td>FULL OUTER JOIN</td>
                        </tr>
                        <tr>
                            <td><code>cross</code></td>
                            <td>Produto cartesiano</td>
                            <td>CROSS JOIN</td>
                        </tr>
                    </table>

                    <pre><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

<span class="comment"># DataFrames de exemplo</span>
vendas = pd.DataFrame({
    <span class="string">'produto_id'</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],
    <span class="string">'valor'</span>: [<span class="number">100</span>, <span class="number">200</span>, <span class="number">150</span>, <span class="number">300</span>],
    <span class="string">'loja_id'</span>: [<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'A'</span>, <span class="string">'C'</span>]
})

produtos = pd.DataFrame({
    <span class="string">'id'</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>],
    <span class="string">'nome'</span>: [<span class="string">'Notebook'</span>, <span class="string">'Mouse'</span>, <span class="string">'Teclado'</span>]
})

<span class="comment"># Merge com colunas de nomes diferentes</span>
resultado = vendas.<span class="function">merge</span>(
    produtos,
    left_on=<span class="string">'produto_id'</span>,
    right_on=<span class="string">'id'</span>,
    how=<span class="string">'left'</span>,
    indicator=<span class="keyword">True</span>  <span class="comment"># Mostra origem de cada linha!</span>
)
</code></pre>

                    <h4>Merge com M√∫ltiplas Chaves</h4>
                    <pre><code><span class="comment"># Merge por m√∫ltiplas colunas</span>
df1 = pd.DataFrame({
    <span class="string">'ano'</span>: [<span class="number">2023</span>, <span class="number">2023</span>, <span class="number">2024</span>],
    <span class="string">'mes'</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>],
    <span class="string">'vendas'</span>: [<span class="number">1000</span>, <span class="number">1500</span>, <span class="number">2000</span>]
})

df2 = pd.DataFrame({
    <span class="string">'ano'</span>: [<span class="number">2023</span>, <span class="number">2024</span>],
    <span class="string">'mes'</span>: [<span class="number">1</span>, <span class="number">1</span>],
    <span class="string">'meta'</span>: [<span class="number">900</span>, <span class="number">1800</span>]
})

<span class="comment"># Merge por ano E m√™s</span>
resultado = df1.<span class="function">merge</span>(df2, on=[<span class="string">'ano'</span>, <span class="string">'mes'</span>])
</code></pre>

                    <h4>Merge Asof (Para S√©ries Temporais)</h4>
                    <p>√ötil quando as chaves n√£o s√£o exatamente iguais - faz match com o valor mais pr√≥ximo.</p>
                    <pre><code><span class="comment"># Dados de pre√ßos em hor√°rios diferentes</span>
precos = pd.DataFrame({
    <span class="string">'timestamp'</span>: pd.<span class="function">to_datetime</span>([<span class="string">'2024-01-01 10:00'</span>, <span class="string">'2024-01-01 10:05'</span>, <span class="string">'2024-01-01 10:10'</span>]),
    <span class="string">'preco'</span>: [<span class="number">100.5</span>, <span class="number">101.2</span>, <span class="number">100.8</span>]
})

trades = pd.DataFrame({
    <span class="string">'timestamp'</span>: pd.<span class="function">to_datetime</span>([<span class="string">'2024-01-01 10:03'</span>, <span class="string">'2024-01-01 10:07'</span>]),
    <span class="string">'quantidade'</span>: [<span class="number">100</span>, <span class="number">50</span>]
})

<span class="comment"># Match com pre√ßo mais recente ANTES do trade</span>
resultado = pd.<span class="function">merge_asof</span>(
    trades.<span class="function">sort_values</span>(<span class="string">'timestamp'</span>),
    precos.<span class="function">sort_values</span>(<span class="string">'timestamp'</span>),
    on=<span class="string">'timestamp'</span>,
    direction=<span class="string">'backward'</span>  <span class="comment"># 'forward', 'nearest' tamb√©m dispon√≠veis</span>
)
</code></pre>

                    <div class="tip">
                        <strong>Performance:</strong> Para DataFrames grandes, use <code>pd.merge()</code> em vez de
                        <code>df.merge()</code> - pode ser ligeiramente mais r√°pido.
                    </div>

                    <!-- EXERC√çCIO 1 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 1</span>
                            <span class="exercise-title">Identificando √ìrf√£os</span>
                            <span class="difficulty easy">F√°cil</span>
                        </div>
                        <p>Dado os DataFrames abaixo, encontre todos os pedidos que <strong>n√£o t√™m</strong> cliente
                            correspondente.</p>
                        <pre><code>pedidos = pd.DataFrame({
    <span class="string">'pedido_id'</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],
    <span class="string">'cliente_id'</span>: [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>],
    <span class="string">'valor'</span>: [<span class="number">100</span>, <span class="number">200</span>, <span class="number">150</span>, <span class="number">300</span>, <span class="number">250</span>]
})

clientes = pd.DataFrame({
    <span class="string">'id'</span>: [<span class="number">10</span>, <span class="number">20</span>, <span class="number">60</span>],
    <span class="string">'nome'</span>: [<span class="string">'Ana'</span>, <span class="string">'Bruno'</span>, <span class="string">'Carlos'</span>]
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># Usar indicator=True para identificar origem</span>
merged = pedidos.<span class="function">merge</span>(
    clientes,
    left_on=<span class="string">'cliente_id'</span>,
    right_on=<span class="string">'id'</span>,
    how=<span class="string">'left'</span>,
    indicator=<span class="keyword">True</span>
)

<span class="comment"># Filtrar apenas os que n√£o t√™m match</span>
orfaos = merged[merged[<span class="string">'_merge'</span>] == <span class="string">'left_only'</span>]
<span class="function">print</span>(orfaos[[<span class="string">'pedido_id'</span>, <span class="string">'cliente_id'</span>, <span class="string">'valor'</span>]])

<span class="comment"># Resultado: pedidos 3, 4, 5 (cliente_id 30, 40, 50)</span>
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 2 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 2</span>
                            <span class="exercise-title">Multi-key Merge com Agrega√ß√£o</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Combine vendas com metas e calcule a diferen√ßa percentual para cada loja/m√™s.</p>
                        <pre><code>vendas = pd.DataFrame({
    <span class="string">'loja'</span>: [<span class="string">'SP'</span>, <span class="string">'SP'</span>, <span class="string">'RJ'</span>, <span class="string">'RJ'</span>],
    <span class="string">'mes'</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>],
    <span class="string">'total'</span>: [<span class="number">15000</span>, <span class="number">18000</span>, <span class="number">12000</span>, <span class="number">14000</span>]
})

metas = pd.DataFrame({
    <span class="string">'loja'</span>: [<span class="string">'SP'</span>, <span class="string">'SP'</span>, <span class="string">'RJ'</span>, <span class="string">'RJ'</span>],
    <span class="string">'mes'</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>],
    <span class="string">'meta'</span>: [<span class="number">14000</span>, <span class="number">16000</span>, <span class="number">13000</span>, <span class="number">15000</span>]
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># Merge por m√∫ltiplas chaves</span>
resultado = vendas.<span class="function">merge</span>(metas, on=[<span class="string">'loja'</span>, <span class="string">'mes'</span>])

<span class="comment"># Calcular diferen√ßa percentual</span>
resultado[<span class="string">'diff_pct'</span>] = ((resultado[<span class="string">'total'</span>] - resultado[<span class="string">'meta'</span>]) / resultado[<span class="string">'meta'</span>] * <span class="number">100</span>).<span class="function">round</span>(<span class="number">2</span>)

<span class="function">print</span>(resultado)
<span class="comment"># SP m√™s 1: +7.14%, SP m√™s 2: +12.5%, RJ m√™s 1: -7.69%, RJ m√™s 2: -6.67%</span>
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 3 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 3</span>
                            <span class="exercise-title">Merge Asof para S√©ries Temporais</span>
                            <span class="difficulty hard">Dif√≠cil</span>
                        </div>
                        <p>Voc√™ tem cota√ß√µes de d√≥lar em intervalos irregulares e transa√ß√µes. Associe cada transa√ß√£o com
                            a cota√ß√£o mais recente <strong>dispon√≠vel at√© 2 horas antes</strong>.</p>
                        <pre><code>cotacoes = pd.DataFrame({
    <span class="string">'timestamp'</span>: pd.<span class="function">to_datetime</span>([
        <span class="string">'2024-01-01 08:00'</span>, <span class="string">'2024-01-01 12:00'</span>, <span class="string">'2024-01-01 16:00'</span>
    ]),
    <span class="string">'usd_brl'</span>: [<span class="number">4.95</span>, <span class="number">4.98</span>, <span class="number">5.01</span>]
})

transacoes = pd.DataFrame({
    <span class="string">'timestamp'</span>: pd.<span class="function">to_datetime</span>([
        <span class="string">'2024-01-01 09:30'</span>, <span class="string">'2024-01-01 11:00'</span>, <span class="string">'2024-01-01 14:00'</span>
    ]),
    <span class="string">'valor_usd'</span>: [<span class="number">1000</span>, <span class="number">500</span>, <span class="number">2000</span>]
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># merge_asof com toler√¢ncia de 2 horas</span>
resultado = pd.<span class="function">merge_asof</span>(
    transacoes.<span class="function">sort_values</span>(<span class="string">'timestamp'</span>),
    cotacoes.<span class="function">sort_values</span>(<span class="string">'timestamp'</span>),
    on=<span class="string">'timestamp'</span>,
    direction=<span class="string">'backward'</span>,
    tolerance=pd.<span class="function">Timedelta</span>(<span class="string">'2h'</span>)  <span class="comment"># M√°ximo 2 horas de diferen√ßa</span>
)

<span class="comment"># Calcular valor em BRL</span>
resultado[<span class="string">'valor_brl'</span>] = resultado[<span class="string">'valor_usd'</span>] * resultado[<span class="string">'usd_brl'</span>]

<span class="function">print</span>(resultado)
<span class="comment"># 09:30 usa cota√ß√£o 08:00 (1h30 de diff): 4.95</span>
<span class="comment"># 11:00 usa cota√ß√£o 08:00 (3h de diff): NaN (fora toler√¢ncia!)</span>
<span class="comment"># 14:00 usa cota√ß√£o 12:00 (2h de diff): 4.98</span>
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pr√≥ximas se√ß√µes ser√£o adicionadas... -->

                <!-- 1.2 GROUPBY E AGGREGATIONS -->
                <div class="section">
                    <h3>1.2 GroupBy e Aggregations Avan√ßados</h3>

                    <p>O <code>groupby()</code> vai muito al√©m de <code>.sum()</code> e <code>.mean()</code>. Domine as
                        t√©cnicas avan√ßadas.</p>

                    <h4>Agrega√ß√µes M√∫ltiplas com agg()</h4>
                    <pre><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

df = pd.DataFrame({
    <span class="string">'categoria'</span>: [<span class="string">'A'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'B'</span>, <span class="string">'A'</span>],
    <span class="string">'produto'</span>: [<span class="string">'X'</span>, <span class="string">'Y'</span>, <span class="string">'X'</span>, <span class="string">'Y'</span>, <span class="string">'X'</span>],
    <span class="string">'valor'</span>: [<span class="number">100</span>, <span class="number">200</span>, <span class="number">150</span>, <span class="number">300</span>, <span class="number">120</span>],
    <span class="string">'quantidade'</span>: [<span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">12</span>]
})

<span class="comment"># M√∫ltiplas agrega√ß√µes por coluna</span>
resultado = df.<span class="function">groupby</span>(<span class="string">'categoria'</span>).<span class="function">agg</span>({
    <span class="string">'valor'</span>: [<span class="string">'sum'</span>, <span class="string">'mean'</span>, <span class="string">'max'</span>],
    <span class="string">'quantidade'</span>: [<span class="string">'sum'</span>, <span class="string">'count'</span>]
})

<span class="comment"># Flatten MultiIndex columns</span>
resultado.columns = [<span class="string">'_'</span>.<span class="function">join</span>(col) <span class="keyword">for</span> col <span class="keyword">in</span> resultado.columns]
</code></pre>

                    <h4>Named Aggregations (mais leg√≠vel)</h4>
                    <pre><code><span class="comment"># Agrega√ß√µes nomeadas - mais controle sobre nomes das colunas</span>
resultado = df.<span class="function">groupby</span>(<span class="string">'categoria'</span>).<span class="function">agg</span>(
    total_valor=(<span class="string">'valor'</span>, <span class="string">'sum'</span>),
    media_valor=(<span class="string">'valor'</span>, <span class="string">'mean'</span>),
    max_valor=(<span class="string">'valor'</span>, <span class="string">'max'</span>),
    total_qtd=(<span class="string">'quantidade'</span>, <span class="string">'sum'</span>),
    num_vendas=(<span class="string">'quantidade'</span>, <span class="string">'count'</span>)
).<span class="function">reset_index</span>()
</code></pre>

                    <h4>Fun√ß√µes Customizadas</h4>
                    <pre><code><span class="comment"># Fun√ß√£o lambda</span>
df.<span class="function">groupby</span>(<span class="string">'categoria'</span>)[<span class="string">'valor'</span>].<span class="function">agg</span>(<span class="keyword">lambda</span> x: x.<span class="function">max</span>() - x.<span class="function">min</span>())

<span class="comment"># Fun√ß√£o customizada mais complexa</span>
<span class="keyword">def</span> <span class="function">coef_variacao</span>(x):
    <span class="string">"""Coeficiente de varia√ß√£o = std/mean"""</span>
    <span class="keyword">return</span> x.std() / x.mean() <span class="keyword">if</span> x.mean() != <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>

df.<span class="function">groupby</span>(<span class="string">'categoria'</span>)[<span class="string">'valor'</span>].<span class="function">agg</span>(coef_variacao)

<span class="comment"># M√∫ltiplas fun√ß√µes customizadas</span>
df.<span class="function">groupby</span>(<span class="string">'categoria'</span>)[<span class="string">'valor'</span>].<span class="function">agg</span>([
    (<span class="string">'range'</span>, <span class="keyword">lambda</span> x: x.max() - x.min()),
    (<span class="string">'cv'</span>, coef_variacao),
    (<span class="string">'mediana'</span>, <span class="string">'median'</span>)
])
</code></pre>

                    <h4>Transform vs Apply</h4>
                    <table>
                        <tr>
                            <th>M√©todo</th>
                            <th>Retorna</th>
                            <th>Uso</th>
                        </tr>
                        <tr>
                            <td><code>agg()</code></td>
                            <td>DataFrame menor</td>
                            <td>Resumir dados</td>
                        </tr>
                        <tr>
                            <td><code>transform()</code></td>
                            <td>Mesmo tamanho</td>
                            <td>Broadcast de resultado</td>
                        </tr>
                        <tr>
                            <td><code>apply()</code></td>
                            <td>Flex√≠vel</td>
                            <td>Opera√ß√µes complexas</td>
                        </tr>
                    </table>

                    <pre><code><span class="comment"># Transform: mant√©m tamanho original (√∫til para normaliza√ß√£o)</span>
df[<span class="string">'valor_normalizado'</span>] = df.<span class="function">groupby</span>(<span class="string">'categoria'</span>)[<span class="string">'valor'</span>].<span class="function">transform</span>(
    <span class="keyword">lambda</span> x: (x - x.mean()) / x.std()
)

<span class="comment"># Percentual do grupo</span>
df[<span class="string">'pct_do_grupo'</span>] = df.<span class="function">groupby</span>(<span class="string">'categoria'</span>)[<span class="string">'valor'</span>].<span class="function">transform</span>(
    <span class="keyword">lambda</span> x: x / x.sum() * <span class="number">100</span>
)

<span class="comment"># Apply: para opera√ß√µes mais complexas</span>
<span class="keyword">def</span> <span class="function">top_n</span>(grupo, n=<span class="number">2</span>):
    <span class="keyword">return</span> grupo.<span class="function">nlargest</span>(n, <span class="string">'valor'</span>)

df.<span class="function">groupby</span>(<span class="string">'categoria'</span>).<span class="function">apply</span>(top_n, n=<span class="number">1</span>)
</code></pre>

                    <div class="warning">
                        <strong>Performance:</strong> <code>apply()</code> √© lento! Prefira <code>transform()</code> ou
                        fun√ß√µes vetorizadas sempre que poss√≠vel.
                    </div>

                    <!-- EXERC√çCIO 4 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 4</span>
                            <span class="exercise-title">Ranking dentro de Grupos</span>
                            <span class="difficulty easy">F√°cil</span>
                        </div>
                        <p>Crie uma coluna <code>rank_no_grupo</code> que mostre a posi√ß√£o de cada venda dentro da sua
                            categoria (maior valor = rank 1).</p>
                        <pre><code>vendas = pd.DataFrame({
    <span class="string">'categoria'</span>: [<span class="string">'Eletr√¥nicos'</span>, <span class="string">'Eletr√¥nicos'</span>, <span class="string">'Roupas'</span>, <span class="string">'Roupas'</span>, <span class="string">'Roupas'</span>],
    <span class="string">'produto'</span>: [<span class="string">'TV'</span>, <span class="string">'Celular'</span>, <span class="string">'Camiseta'</span>, <span class="string">'Cal√ßa'</span>, <span class="string">'Vestido'</span>],
    <span class="string">'valor'</span>: [<span class="number">2500</span>, <span class="number">1500</span>, <span class="number">80</span>, <span class="number">150</span>, <span class="number">200</span>]
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code>vendas[<span class="string">'rank_no_grupo'</span>] = vendas.<span class="function">groupby</span>(<span class="string">'categoria'</span>)[<span class="string">'valor'</span>].<span class="function">rank</span>(
    ascending=<span class="keyword">False</span>,
    method=<span class="string">'dense'</span>  <span class="comment"># 'min', 'max', 'first', 'dense'</span>
).<span class="function">astype</span>(int)

<span class="function">print</span>(vendas)
<span class="comment"># TV: rank 1, Celular: rank 2</span>
<span class="comment"># Vestido: rank 1, Cal√ßa: rank 2, Camiseta: rank 3</span>
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 5 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 5</span>
                            <span class="exercise-title">Agrega√ß√£o com Filtro</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Calcule o total de vendas por categoria, mas apenas para produtos com valor acima da m√©dia da
                            categoria.</p>
                        <pre><code>vendas = pd.DataFrame({
    <span class="string">'categoria'</span>: [<span class="string">'A'</span>, <span class="string">'A'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'B'</span>, <span class="string">'B'</span>],
    <span class="string">'valor'</span>: [<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>, <span class="number">50</span>, <span class="number">150</span>, <span class="number">100</span>]
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># Usar transform para comparar com m√©dia do grupo</span>
media_grupo = vendas.<span class="function">groupby</span>(<span class="string">'categoria'</span>)[<span class="string">'valor'</span>].<span class="function">transform</span>(<span class="string">'mean'</span>)

<span class="comment"># Filtrar e agregar</span>
acima_media = vendas[vendas[<span class="string">'valor'</span>] > media_grupo]
resultado = acima_media.<span class="function">groupby</span>(<span class="string">'categoria'</span>)[<span class="string">'valor'</span>].<span class="function">sum</span>()

<span class="function">print</span>(resultado)
<span class="comment"># A: 300 (m√©dia=200, s√≥ 300 passa)</span>
<span class="comment"># B: 150 (m√©dia=100, s√≥ 150 passa)</span>
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 6 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 6</span>
                            <span class="exercise-title">An√°lise de Coorte Simplificada</span>
                            <span class="difficulty hard">Dif√≠cil</span>
                        </div>
                        <p>Para cada cliente, calcule: primeira compra, √∫ltima compra, total gasto, n√∫mero de compras e
                            ticket m√©dio. Depois identifique clientes "inativos" (√∫ltima compra h√° mais de 30 dias).</p>
                        <pre><code>compras = pd.DataFrame({
    <span class="string">'cliente_id'</span>: [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>],
    <span class="string">'data'</span>: pd.<span class="function">to_datetime</span>([
        <span class="string">'2024-01-01'</span>, <span class="string">'2024-01-15'</span>, <span class="string">'2024-02-01'</span>,
        <span class="string">'2024-01-05'</span>, <span class="string">'2024-01-20'</span>, <span class="string">'2024-01-10'</span>
    ]),
    <span class="string">'valor'</span>: [<span class="number">100</span>, <span class="number">150</span>, <span class="number">200</span>, <span class="number">50</span>, <span class="number">75</span>, <span class="number">300</span>]
})
<span class="comment"># Considere hoje = 2024-02-10</span>
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code>hoje = pd.<span class="function">Timestamp</span>(<span class="string">'2024-02-10'</span>)

<span class="comment"># Agrega√ß√£o completa</span>
analise = compras.<span class="function">groupby</span>(<span class="string">'cliente_id'</span>).<span class="function">agg</span>(
    primeira_compra=(<span class="string">'data'</span>, <span class="string">'min'</span>),
    ultima_compra=(<span class="string">'data'</span>, <span class="string">'max'</span>),
    total_gasto=(<span class="string">'valor'</span>, <span class="string">'sum'</span>),
    num_compras=(<span class="string">'valor'</span>, <span class="string">'count'</span>),
    ticket_medio=(<span class="string">'valor'</span>, <span class="string">'mean'</span>)
).<span class="function">reset_index</span>()

<span class="comment"># Dias desde √∫ltima compra</span>
analise[<span class="string">'dias_inativo'</span>] = (hoje - analise[<span class="string">'ultima_compra'</span>]).dt.days

<span class="comment"># Marcar inativos</span>
analise[<span class="string">'status'</span>] = np.<span class="function">where</span>(
    analise[<span class="string">'dias_inativo'</span>] > <span class="number">30</span>,
    <span class="string">'Inativo'</span>,
    <span class="string">'Ativo'</span>
)

<span class="function">print</span>(analise)
<span class="comment"># Cliente 1: Ativo (9 dias)</span>
<span class="comment"># Cliente 2: Inativo (21 dias? N√£o, 21 < 30 = Ativo)</span>
<span class="comment"># Cliente 3: Inativo (31 dias)</span>
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1.3 WINDOW FUNCTIONS -->
                <div class="section">
                    <h3>1.3 Window Functions (Rolling, Expanding, EWM)</h3>

                    <p>Window Functions permitem c√°lculos sobre janelas de dados - essenciais para s√©ries temporais.</p>

                    <h4>Rolling (Janela M√≥vel)</h4>
                    <pre><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

<span class="comment"># Dados de vendas di√°rias</span>
df = pd.DataFrame({
    <span class="string">'data'</span>: pd.<span class="function">date_range</span>(<span class="string">'2024-01-01'</span>, periods=<span class="number">10</span>),
    <span class="string">'vendas'</span>: [<span class="number">100</span>, <span class="number">120</span>, <span class="number">90</span>, <span class="number">150</span>, <span class="number">200</span>, <span class="number">180</span>, <span class="number">160</span>, <span class="number">190</span>, <span class="number">210</span>, <span class="number">230</span>]
})

<span class="comment"># M√©dia m√≥vel de 3 dias</span>
df[<span class="string">'media_movel_3'</span>] = df[<span class="string">'vendas'</span>].<span class="function">rolling</span>(window=<span class="number">3</span>).<span class="function">mean</span>()

<span class="comment"># M√∫ltiplas agrega√ß√µes</span>
rolling = df[<span class="string">'vendas'</span>].<span class="function">rolling</span>(window=<span class="number">3</span>)
df[<span class="string">'min_3'</span>] = rolling.<span class="function">min</span>()
df[<span class="string">'max_3'</span>] = rolling.<span class="function">max</span>()
df[<span class="string">'std_3'</span>] = rolling.<span class="function">std</span>()

<span class="comment"># Janela centralizada (olha para frente e tr√°s)</span>
df[<span class="string">'media_central'</span>] = df[<span class="string">'vendas'</span>].<span class="function">rolling</span>(window=<span class="number">3</span>, center=<span class="keyword">True</span>).<span class="function">mean</span>()
</code></pre>

                    <h4>Rolling com Tempo (em vez de linhas)</h4>
                    <pre><code><span class="comment"># √ötil para dados com timestamps irregulares</span>
df = df.<span class="function">set_index</span>(<span class="string">'data'</span>)

<span class="comment"># M√©dia dos √∫ltimos 5 dias (n√£o 5 linhas!)</span>
df[<span class="string">'media_5d'</span>] = df[<span class="string">'vendas'</span>].<span class="function">rolling</span>(<span class="string">'5D'</span>).<span class="function">mean</span>()

<span class="comment"># Com min_periods (m√≠nimo de observa√ß√µes)</span>
df[<span class="string">'media_7d'</span>] = df[<span class="string">'vendas'</span>].<span class="function">rolling</span>(<span class="string">'7D'</span>, min_periods=<span class="number">3</span>).<span class="function">mean</span>()
</code></pre>

                    <h4>Expanding (Janela Cumulativa)</h4>
                    <pre><code><span class="comment"># Acumulados desde o in√≠cio</span>
df[<span class="string">'soma_acum'</span>] = df[<span class="string">'vendas'</span>].<span class="function">expanding</span>().<span class="function">sum</span>()
df[<span class="string">'media_acum'</span>] = df[<span class="string">'vendas'</span>].<span class="function">expanding</span>().<span class="function">mean</span>()
df[<span class="string">'max_historico'</span>] = df[<span class="string">'vendas'</span>].<span class="function">expanding</span>().<span class="function">max</span>()

<span class="comment"># √â equivalente a:</span>
df[<span class="string">'soma_acum_alt'</span>] = df[<span class="string">'vendas'</span>].<span class="function">cumsum</span>()
</code></pre>

                    <h4>EWM (M√©dia M√≥vel Exponencial)</h4>
                    <pre><code><span class="comment"># M√©dia m√≥vel exponencial - d√° mais peso a valores recentes</span>
df[<span class="string">'ewm_span'</span>] = df[<span class="string">'vendas'</span>].<span class="function">ewm</span>(span=<span class="number">3</span>).<span class="function">mean</span>()  <span class="comment"># span = per√≠odo</span>
df[<span class="string">'ewm_alpha'</span>] = df[<span class="string">'vendas'</span>].<span class="function">ewm</span>(alpha=<span class="number">0.5</span>).<span class="function">mean</span>()  <span class="comment"># alpha = fator de decaimento</span>

<span class="comment"># √ötil para suaviza√ß√£o de s√©ries temporais</span>
</code></pre>

                    <h4>Shift e Diff (Compara√ß√µes Temporais)</h4>
                    <pre><code><span class="comment"># Valor do per√≠odo anterior</span>
df[<span class="string">'vendas_ontem'</span>] = df[<span class="string">'vendas'</span>].<span class="function">shift</span>(<span class="number">1</span>)

<span class="comment"># Varia√ß√£o em rela√ß√£o ao per√≠odo anterior</span>
df[<span class="string">'variacao'</span>] = df[<span class="string">'vendas'</span>].<span class="function">diff</span>()

<span class="comment"># Varia√ß√£o percentual</span>
df[<span class="string">'var_pct'</span>] = df[<span class="string">'vendas'</span>].<span class="function">pct_change</span>() * <span class="number">100</span>

<span class="comment"># Comparar com 7 dias atr√°s</span>
df[<span class="string">'var_7d'</span>] = df[<span class="string">'vendas'</span>] - df[<span class="string">'vendas'</span>].<span class="function">shift</span>(<span class="number">7</span>)
</code></pre>

                    <div class="note">
                        <strong>Diferen√ßa shift vs rolling:</strong> <code>shift()</code> apenas desloca valores;
                        <code>rolling()</code> calcula agrega√ß√µes sobre a janela.
                    </div>

                    <!-- EXERC√çCIO 7 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 7</span>
                            <span class="exercise-title">Detectar Anomalias com Rolling</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Identifique dias onde as vendas est√£o <strong>mais de 2 desvios padr√µes</strong> acima da
                            m√©dia m√≥vel de 5 dias.</p>
                        <pre><code>vendas = pd.DataFrame({
    <span class="string">'data'</span>: pd.<span class="function">date_range</span>(<span class="string">'2024-01-01'</span>, periods=<span class="number">15</span>),
    <span class="string">'valor'</span>: [<span class="number">100</span>, <span class="number">105</span>, <span class="number">98</span>, <span class="number">102</span>, <span class="number">100</span>, <span class="number">250</span>, <span class="number">103</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">100</span>, 
              <span class="number">98</span>, <span class="number">102</span>, <span class="number">300</span>, <span class="number">100</span>, <span class="number">99</span>]
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># Calcular m√©dia e desvio m√≥vel</span>
vendas[<span class="string">'media_5d'</span>] = vendas[<span class="string">'valor'</span>].<span class="function">rolling</span>(<span class="number">5</span>).<span class="function">mean</span>()
vendas[<span class="string">'std_5d'</span>] = vendas[<span class="string">'valor'</span>].<span class="function">rolling</span>(<span class="number">5</span>).<span class="function">std</span>()

<span class="comment"># Limite superior (2 desvios)</span>
vendas[<span class="string">'limite_sup'</span>] = vendas[<span class="string">'media_5d'</span>] + <span class="number">2</span> * vendas[<span class="string">'std_5d'</span>]

<span class="comment"># Marcar anomalias</span>
vendas[<span class="string">'anomalia'</span>] = vendas[<span class="string">'valor'</span>] > vendas[<span class="string">'limite_sup'</span>]

<span class="comment"># Ver anomalias</span>
anomalias = vendas[vendas[<span class="string">'anomalia'</span>]]
<span class="function">print</span>(anomalias[[<span class="string">'data'</span>, <span class="string">'valor'</span>, <span class="string">'media_5d'</span>, <span class="string">'limite_sup'</span>]])
<span class="comment"># Dia 6 (250) e dia 13 (300) ser√£o anomalias</span>
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 8 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 8</span>
                            <span class="exercise-title">Year-over-Year Growth</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Calcule o crescimento percentual m√™s-a-m√™s (MoM) e ano-a-ano (YoY) para os dados abaixo.</p>
                        <pre><code>faturamento = pd.DataFrame({
    <span class="string">'mes'</span>: pd.<span class="function">date_range</span>(<span class="string">'2022-01-01'</span>, periods=<span class="number">24</span>, freq=<span class="string">'MS'</span>),
    <span class="string">'valor'</span>: [<span class="number">100</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">120</span>, <span class="number">130</span>, <span class="number">125</span>, <span class="number">140</span>, <span class="number">150</span>, <span class="number">145</span>, <span class="number">160</span>, <span class="number">170</span>, <span class="number">180</span>,
              <span class="number">120</span>, <span class="number">130</span>, <span class="number">125</span>, <span class="number">140</span>, <span class="number">155</span>, <span class="number">150</span>, <span class="number">165</span>, <span class="number">175</span>, <span class="number">170</span>, <span class="number">185</span>, <span class="number">200</span>, <span class="number">210</span>]
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># MoM (m√™s anterior)</span>
faturamento[<span class="string">'mom_pct'</span>] = faturamento[<span class="string">'valor'</span>].<span class="function">pct_change</span>() * <span class="number">100</span>

<span class="comment"># YoY (12 meses atr√°s)</span>
faturamento[<span class="string">'yoy_pct'</span>] = faturamento[<span class="string">'valor'</span>].<span class="function">pct_change</span>(periods=<span class="number">12</span>) * <span class="number">100</span>

<span class="comment"># Alternativa para YoY</span>
faturamento[<span class="string">'valor_ano_passado'</span>] = faturamento[<span class="string">'valor'</span>].<span class="function">shift</span>(<span class="number">12</span>)
faturamento[<span class="string">'yoy_alt'</span>] = (faturamento[<span class="string">'valor'</span>] / faturamento[<span class="string">'valor_ano_passado'</span>] - <span class="number">1</span>) * <span class="number">100</span>

<span class="function">print</span>(faturamento)
<span class="comment"># Janeiro 2023: YoY = (120-100)/100 = 20%</span>
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 9 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 9</span>
                            <span class="exercise-title">M√°ximo Hist√≥rico (All-Time High)</span>
                            <span class="difficulty easy">F√°cil</span>
                        </div>
                        <p>Crie uma coluna que indique se o pre√ßo da a√ß√£o atingiu um novo m√°ximo hist√≥rico naquele dia.
                        </p>
                        <pre><code>acoes = pd.DataFrame({
    <span class="string">'data'</span>: pd.<span class="function">date_range</span>(<span class="string">'2024-01-01'</span>, periods=<span class="number">10</span>),
    <span class="string">'preco'</span>: [<span class="number">100</span>, <span class="number">102</span>, <span class="number">98</span>, <span class="number">105</span>, <span class="number">103</span>, <span class="number">110</span>, <span class="number">108</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">120</span>]
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># M√°ximo hist√≥rico at√© aquele ponto</span>
acoes[<span class="string">'max_historico'</span>] = acoes[<span class="string">'preco'</span>].<span class="function">expanding</span>().<span class="function">max</span>()

<span class="comment"># Novo ATH?</span>
acoes[<span class="string">'novo_ath'</span>] = acoes[<span class="string">'preco'</span>] == acoes[<span class="string">'max_historico'</span>]

<span class="comment"># Ou de forma mais direta:</span>
acoes[<span class="string">'novo_ath_v2'</span>] = acoes[<span class="string">'preco'</span>] > acoes[<span class="string">'preco'</span>].<span class="function">shift</span>().<span class="function">expanding</span>().<span class="function">max</span>()

<span class="function">print</span>(acoes)
<span class="comment"># ATHs: dia 1 (100), dia 2 (102), dia 4 (105), dia 6 (110), dia 8 (115), dia 10 (120)</span>
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1.4 OTIMIZA√á√ÉO DE PERFORMANCE -->
                <div class="section">
                    <h3>1.4 Otimiza√ß√£o de Performance</h3>

                    <p>DataFrames grandes podem ser lentos. Aprenda a otimizar mem√≥ria e velocidade.</p>

                    <h4>Reduzindo Uso de Mem√≥ria</h4>
                    <pre><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

<span class="comment"># Ver uso de mem√≥ria</span>
df.<span class="function">info</span>(memory_usage=<span class="string">'deep'</span>)
<span class="function">print</span>(df.<span class="function">memory_usage</span>(deep=<span class="keyword">True</span>).<span class="function">sum</span>() / <span class="number">1024</span>**<span class="number">2</span>, <span class="string">'MB'</span>)

<span class="comment"># Otimizar tipos num√©ricos</span>
<span class="keyword">def</span> <span class="function">optimize_dtypes</span>(df):
    <span class="keyword">for</span> col <span class="keyword">in</span> df.<span class="function">select_dtypes</span>(include=[<span class="string">'int64'</span>]).columns:
        df[col] = pd.<span class="function">to_numeric</span>(df[col], downcast=<span class="string">'integer'</span>)
    <span class="keyword">for</span> col <span class="keyword">in</span> df.<span class="function">select_dtypes</span>(include=[<span class="string">'float64'</span>]).columns:
        df[col] = pd.<span class="function">to_numeric</span>(df[col], downcast=<span class="string">'float'</span>)
    <span class="keyword">return</span> df

<span class="comment"># Usar category para strings repetidas</span>
df[<span class="string">'categoria'</span>] = df[<span class="string">'categoria'</span>].<span class="function">astype</span>(<span class="string">'category'</span>)  <span class="comment"># Economia enorme!</span>
</code></pre>

                    <h4>Ler Arquivos Grandes em Chunks</h4>
                    <pre><code><span class="comment"># Processar arquivo grande em peda√ßos</span>
resultado = []
<span class="keyword">for</span> chunk <span class="keyword">in</span> pd.<span class="function">read_csv</span>(<span class="string">'arquivo_grande.csv'</span>, chunksize=<span class="number">100000</span>):
    <span class="comment"># Processar cada chunk</span>
    chunk_processado = chunk[chunk[<span class="string">'valor'</span>] > <span class="number">100</span>]
    resultado.<span class="function">append</span>(chunk_processado)

df = pd.<span class="function">concat</span>(resultado, ignore_index=<span class="keyword">True</span>)

<span class="comment"># Ler apenas colunas necess√°rias</span>
df = pd.<span class="function">read_csv</span>(<span class="string">'arquivo.csv'</span>, usecols=[<span class="string">'col1'</span>, <span class="string">'col2'</span>, <span class="string">'col3'</span>])
</code></pre>

                    <h4>Evitar Loops - Use Vetoriza√ß√£o</h4>
                    <pre><code><span class="comment"># ‚ùå LENTO - loop com iterrows</span>
<span class="keyword">for</span> idx, row <span class="keyword">in</span> df.<span class="function">iterrows</span>():
    df.<span class="function">loc</span>[idx, <span class="string">'novo'</span>] = row[<span class="string">'a'</span>] + row[<span class="string">'b'</span>]

<span class="comment"># ‚úÖ R√ÅPIDO - opera√ß√£o vetorizada</span>
df[<span class="string">'novo'</span>] = df[<span class="string">'a'</span>] + df[<span class="string">'b'</span>]

<span class="comment"># ‚ùå LENTO - apply com fun√ß√£o Python</span>
df[<span class="string">'resultado'</span>] = df[<span class="string">'texto'</span>].<span class="function">apply</span>(<span class="keyword">lambda</span> x: x.<span class="function">upper</span>())

<span class="comment"># ‚úÖ R√ÅPIDO - m√©todo vetorizado</span>
df[<span class="string">'resultado'</span>] = df[<span class="string">'texto'</span>].str.<span class="function">upper</span>()
</code></pre>

                    <h4>Query e Eval para Grandes DataFrames</h4>
                    <pre><code><span class="comment"># query() - sintaxe mais limpa e pode ser mais r√°pido</span>
df_filtrado = df.<span class="function">query</span>(<span class="string">'valor > 100 and categoria == "A"'</span>)

<span class="comment"># eval() - para express√µes complexas</span>
df[<span class="string">'resultado'</span>] = df.<span class="function">eval</span>(<span class="string">'(col1 + col2) / col3 * 100'</span>)

<span class="comment"># Ambos usam numexpr por baixo, evitando intermedi√°rios</span>
</code></pre>

                    <h4>Compara√ß√£o de Performance</h4>
                    <table>
                        <tr>
                            <th>Opera√ß√£o</th>
                            <th>Velocidade</th>
                            <th>Quando Usar</th>
                        </tr>
                        <tr>
                            <td>Vetoriza√ß√£o NumPy/Pandas</td>
                            <td>‚ö°‚ö°‚ö°‚ö°‚ö°</td>
                            <td>Sempre que poss√≠vel</td>
                        </tr>
                        <tr>
                            <td><code>apply()</code> com NumPy</td>
                            <td>‚ö°‚ö°‚ö°‚ö°</td>
                            <td>Fun√ß√µes NumPy complexas</td>
                        </tr>
                        <tr>
                            <td><code>apply()</code> com Python</td>
                            <td>‚ö°‚ö°</td>
                            <td>√öltimo recurso</td>
                        </tr>
                        <tr>
                            <td><code>itertuples()</code></td>
                            <td>‚ö°‚ö°</td>
                            <td>Precisa iterar</td>
                        </tr>
                        <tr>
                            <td><code>iterrows()</code></td>
                            <td>‚ö°</td>
                            <td>Evitar!</td>
                        </tr>
                    </table>

                    <div class="tip">
                        <strong>Dica Pro:</strong> Use <code>%%timeit</code> no Jupyter para medir performance real.
                    </div>

                    <!-- EXERC√çCIO 10 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 10</span>
                            <span class="exercise-title">Otimizar Mem√≥ria</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Crie uma fun√ß√£o que reduza o uso de mem√≥ria de um DataFrame otimizando os tipos de dados
                            automaticamente.</p>
                        <pre><code><span class="comment"># DataFrame de exemplo</span>
df = pd.DataFrame({
    <span class="string">'id'</span>: np.<span class="function">arange</span>(<span class="number">1000000</span>),  <span class="comment"># int64</span>
    <span class="string">'valor'</span>: np.<span class="function">random.random</span>(<span class="number">1000000</span>),  <span class="comment"># float64</span>
    <span class="string">'categoria'</span>: np.<span class="function">random.choice</span>([<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>], <span class="number">1000000</span>)  <span class="comment"># object</span>
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">def</span> <span class="function">reduce_memory</span>(df, verbose=<span class="keyword">True</span>):
    <span class="string">"""Reduz uso de mem√≥ria otimizando tipos"""</span>
    start_mem = df.memory_usage(deep=<span class="keyword">True</span>).sum() / <span class="number">1024</span>**<span class="number">2</span>
    
    <span class="keyword">for</span> col <span class="keyword">in</span> df.columns:
        col_type = df[col].dtype
        
        <span class="keyword">if</span> col_type <span class="keyword">in</span> [<span class="string">'int64'</span>, <span class="string">'int32'</span>]:
            df[col] = pd.<span class="function">to_numeric</span>(df[col], downcast=<span class="string">'integer'</span>)
        <span class="keyword">elif</span> col_type <span class="keyword">in</span> [<span class="string">'float64'</span>, <span class="string">'float32'</span>]:
            df[col] = pd.<span class="function">to_numeric</span>(df[col], downcast=<span class="string">'float'</span>)
        <span class="keyword">elif</span> col_type == <span class="string">'object'</span>:
            <span class="comment"># Se poucas categorias √∫nicas, converter</span>
            <span class="keyword">if</span> df[col].nunique() / <span class="function">len</span>(df) < <span class="number">0.5</span>:
                df[col] = df[col].<span class="function">astype</span>(<span class="string">'category'</span>)
    
    end_mem = df.memory_usage(deep=<span class="keyword">True</span>).sum() / <span class="number">1024</span>**<span class="number">2</span>
    
    <span class="keyword">if</span> verbose:
        <span class="function">print</span>(<span class="string">f'Mem√≥ria: {start_mem:.2f}MB ‚Üí {end_mem:.2f}MB '</span>
              <span class="string">f'(redu√ß√£o de {100*(start_mem-end_mem)/start_mem:.1f}%)'</span>)
    
    <span class="keyword">return</span> df

df = <span class="function">reduce_memory</span>(df)
<span class="comment"># Esperado: redu√ß√£o de ~70-80% de mem√≥ria!</span>
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 11 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 11</span>
                            <span class="exercise-title">Refatorar para Vetoriza√ß√£o</span>
                            <span class="difficulty hard">Dif√≠cil</span>
                        </div>
                        <p>Refatore o c√≥digo abaixo (que usa loop) para usar opera√ß√µes vetorizadas.</p>
                        <pre><code><span class="comment"># C√≥digo lento com loop</span>
df = pd.DataFrame({
    <span class="string">'preco'</span>: [<span class="number">100</span>, <span class="number">250</span>, <span class="number">500</span>, <span class="number">1000</span>, <span class="number">50</span>],
    <span class="string">'quantidade'</span>: [<span class="number">10</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">20</span>]
})

<span class="comment"># Calcular desconto baseado em faixas de pre√ßo</span>
<span class="keyword">for</span> idx, row <span class="keyword">in</span> df.<span class="function">iterrows</span>():
    <span class="keyword">if</span> row[<span class="string">'preco'</span>] < <span class="number">100</span>:
        df.<span class="function">loc</span>[idx, <span class="string">'desconto'</span>] = <span class="number">0</span>
    <span class="keyword">elif</span> row[<span class="string">'preco'</span>] < <span class="number">500</span>:
        df.<span class="function">loc</span>[idx, <span class="string">'desconto'</span>] = <span class="number">0.05</span>
    <span class="keyword">else</span>:
        df.<span class="function">loc</span>[idx, <span class="string">'desconto'</span>] = <span class="number">0.10</span>
    
    df.<span class="function">loc</span>[idx, <span class="string">'total'</span>] = row[<span class="string">'preco'</span>] * row[<span class="string">'quantidade'</span>] * (<span class="number">1</span> - df.<span class="function">loc</span>[idx, <span class="string">'desconto'</span>])
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># Vers√£o vetorizada com np.select</span>
condicoes = [
    df[<span class="string">'preco'</span>] < <span class="number">100</span>,
    df[<span class="string">'preco'</span>] < <span class="number">500</span>,
    df[<span class="string">'preco'</span>] >= <span class="number">500</span>
]
descontos = [<span class="number">0</span>, <span class="number">0.05</span>, <span class="number">0.10</span>]

df[<span class="string">'desconto'</span>] = np.<span class="function">select</span>(condicoes, descontos)
df[<span class="string">'total'</span>] = df[<span class="string">'preco'</span>] * df[<span class="string">'quantidade'</span>] * (<span class="number">1</span> - df[<span class="string">'desconto'</span>])

<span class="comment"># Alternativa com pd.cut</span>
df[<span class="string">'desconto_v2'</span>] = pd.<span class="function">cut</span>(
    df[<span class="string">'preco'</span>],
    bins=[<span class="number">0</span>, <span class="number">100</span>, <span class="number">500</span>, np.inf],
    labels=[<span class="number">0</span>, <span class="number">0.05</span>, <span class="number">0.10</span>]
).<span class="function">astype</span>(float)

<span class="function">print</span>(df)
<span class="comment"># ~100x mais r√°pido em DataFrames grandes!</span>
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- M√ìDULO 2: NUMPY AVAN√áADO -->
        <div class="module" id="modulo2">
            <div class="module-header">
                <h2>üî¢ M√≥dulo 2: NumPy Avan√ßado</h2>
            </div>
            <div class="module-content">
                <!-- 2.1 OPERA√á√ïES VETORIZADAS -->
                <div class="section">
                    <h3>2.1 Opera√ß√µes Vetorizadas</h3>

                    <p>Vetoriza√ß√£o √© a chave para performance em Python num√©rico. Evite loops a todo custo!</p>

                    <h4>Fundamentos da Vetoriza√ß√£o</h4>
                    <pre><code><span class="keyword">import</span> numpy <span class="keyword">as</span> np

<span class="comment"># ‚ùå Lento: loop Python</span>
arr = np.<span class="function">random.random</span>(<span class="number">1000000</span>)
resultado = []
<span class="keyword">for</span> x <span class="keyword">in</span> arr:
    resultado.<span class="function">append</span>(x ** <span class="number">2</span> + <span class="number">2</span> * x + <span class="number">1</span>)

<span class="comment"># ‚úÖ R√°pido: opera√ß√£o vetorizada (~100x mais r√°pido)</span>
resultado = arr ** <span class="number">2</span> + <span class="number">2</span> * arr + <span class="number">1</span>
</code></pre>

                    <h4>Universal Functions (ufuncs)</h4>
                    <pre><code><span class="comment"># Ufuncs operam elemento a elemento automaticamente</span>
arr = np.<span class="function">array</span>([<span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>])

<span class="comment"># Matem√°ticas</span>
np.<span class="function">sqrt</span>(arr)        <span class="comment"># [1, 2, 3, 4, 5]</span>
np.<span class="function">exp</span>(arr)         <span class="comment"># Exponencial</span>
np.<span class="function">log</span>(arr)         <span class="comment"># Logaritmo natural</span>
np.<span class="function">sin</span>(arr)         <span class="comment"># Seno</span>

<span class="comment"># Compara√ß√µes (retornam arrays booleanos)</span>
arr > <span class="number">5</span>             <span class="comment"># [False, False, True, True, True]</span>
np.<span class="function">logical_and</span>(arr > <span class="number">5</span>, arr < <span class="number">20</span>)  <span class="comment"># [False, False, True, True, False]</span>

<span class="comment"># Agrega√ß√µes</span>
np.<span class="function">sum</span>(arr)         <span class="comment"># 55</span>
np.<span class="function">mean</span>(arr)        <span class="comment"># 11.0</span>
np.<span class="function">std</span>(arr)         <span class="comment"># Desvio padr√£o</span>
np.<span class="function">cumsum</span>(arr)      <span class="comment"># [1, 5, 14, 30, 55]</span>
</code></pre>

                    <h4>Where: Condicional Vetorizado</h4>
                    <pre><code><span class="comment"># np.where √© o if/else vetorizado</span>
precos = np.<span class="function">array</span>([<span class="number">100</span>, <span class="number">250</span>, <span class="number">50</span>, <span class="number">400</span>, <span class="number">150</span>])

<span class="comment"># Desconto de 10% para pre√ßos acima de 200</span>
precos_finais = np.<span class="function">where</span>(precos > <span class="number">200</span>, precos * <span class="number">0.9</span>, precos)
<span class="comment"># [100, 225, 50, 360, 150]</span>

<span class="comment"># M√∫ltiplas condi√ß√µes com np.select</span>
condicoes = [precos < <span class="number">100</span>, precos < <span class="number">300</span>, precos >= <span class="number">300</span>]
valores = [<span class="string">'barato'</span>, <span class="string">'m√©dio'</span>, <span class="string">'caro'</span>]
categorias = np.<span class="function">select</span>(condicoes, valores)
</code></pre>

                    <h4>Opera√ß√µes ao Longo de Eixos</h4>
                    <pre><code>matriz = np.<span class="function">array</span>([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],
                   [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>],
                   [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]])

<span class="comment"># axis=0: opera ao longo das linhas (colapsa verticalmente)</span>
np.<span class="function">sum</span>(matriz, axis=<span class="number">0</span>)   <span class="comment"># [12, 15, 18]</span>

<span class="comment"># axis=1: opera ao longo das colunas (colapsa horizontalmente)</span>
np.<span class="function">sum</span>(matriz, axis=<span class="number">1</span>)   <span class="comment"># [6, 15, 24]</span>

<span class="comment"># Sem axis: todos os elementos</span>
np.<span class="function">sum</span>(matriz)          <span class="comment"># 45</span>

<span class="comment"># Manter dimens√µes (√∫til para broadcasting)</span>
np.<span class="function">sum</span>(matriz, axis=<span class="number">1</span>, keepdims=<span class="keyword">True</span>)  <span class="comment"># [[6], [15], [24]]</span>
</code></pre>

                    <!-- EXERC√çCIO 12 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 12</span>
                            <span class="exercise-title">Normaliza√ß√£o Z-Score</span>
                            <span class="difficulty easy">F√°cil</span>
                        </div>
                        <p>Normalize cada coluna de uma matriz usando Z-score: <code>(x - m√©dia) / desvio_padr√£o</code>,
                            usando apenas opera√ß√µes vetorizadas.</p>
                        <pre><code>dados = np.<span class="function">array</span>([
    [<span class="number">100</span>, <span class="number">20</span>, <span class="number">0.5</span>],
    [<span class="number">150</span>, <span class="number">30</span>, <span class="number">0.8</span>],
    [<span class="number">200</span>, <span class="number">25</span>, <span class="number">0.6</span>],
    [<span class="number">120</span>, <span class="number">35</span>, <span class="number">0.9</span>]
])
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># Calcular m√©dia e std por coluna</span>
media = dados.<span class="function">mean</span>(axis=<span class="number">0</span>)  <span class="comment"># Shape: (3,)</span>
std = dados.<span class="function">std</span>(axis=<span class="number">0</span>)      <span class="comment"># Shape: (3,)</span>

<span class="comment"># Normalizar (broadcasting autom√°tico!)</span>
dados_norm = (dados - media) / std

<span class="function">print</span>(<span class="string">"M√©dias por coluna (devem ser ~0):"</span>, dados_norm.<span class="function">mean</span>(axis=<span class="number">0</span>).<span class="function">round</span>(<span class="number">10</span>))
<span class="function">print</span>(<span class="string">"STDs por coluna (devem ser ~1):"</span>, dados_norm.<span class="function">std</span>(axis=<span class="number">0</span>).<span class="function">round</span>(<span class="number">10</span>))
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 13 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 13</span>
                            <span class="exercise-title">Classifica√ß√£o de Scores</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Crie uma fun√ß√£o que classifique scores em categorias usando apenas NumPy vetorizado.</p>
                        <pre><code>scores = np.<span class="function">array</span>([<span class="number">85</span>, <span class="number">42</span>, <span class="number">67</span>, <span class="number">93</span>, <span class="number">55</span>, <span class="number">78</span>, <span class="number">31</span>, <span class="number">88</span>])

<span class="comment"># Classificar em:</span>
<span class="comment"># A: >= 90</span>
<span class="comment"># B: >= 80</span>
<span class="comment"># C: >= 70</span>
<span class="comment"># D: >= 60</span>
<span class="comment"># F: < 60</span>
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">def</span> <span class="function">classificar_scores</span>(scores):
    <span class="comment"># Usar np.select para m√∫ltiplas condi√ß√µes</span>
    condicoes = [
        scores >= <span class="number">90</span>,
        scores >= <span class="number">80</span>,
        scores >= <span class="number">70</span>,
        scores >= <span class="number">60</span>,
        scores < <span class="number">60</span>
    ]
    categorias = [<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'F'</span>]
    <span class="keyword">return</span> np.<span class="function">select</span>(condicoes, categorias)

resultado = <span class="function">classificar_scores</span>(scores)
<span class="function">print</span>(resultado)
<span class="comment"># ['B', 'F', 'D', 'A', 'F', 'C', 'F', 'B']</span>

<span class="comment"># Alternativa com np.digitize</span>
bins = [<span class="number">0</span>, <span class="number">60</span>, <span class="number">70</span>, <span class="number">80</span>, <span class="number">90</span>, <span class="number">101</span>]
labels = np.<span class="function">array</span>([<span class="string">'F'</span>, <span class="string">'D'</span>, <span class="string">'C'</span>, <span class="string">'B'</span>, <span class="string">'A'</span>])
indices = np.<span class="function">digitize</span>(scores, bins[<span class="number">1</span>:])
resultado_v2 = labels[indices]
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2.2 BROADCASTING -->
                <div class="section">
                    <h3>2.2 Broadcasting</h3>

                    <p>Broadcasting permite opera√ß√µes entre arrays de shapes diferentes. Entenda as regras!</p>

                    <h4>Regras do Broadcasting</h4>
                    <div class="note">
                        <strong>Regra 1:</strong> Comparar shapes da direita para esquerda.<br>
                        <strong>Regra 2:</strong> Dimens√µes s√£o compat√≠veis se iguais ou uma delas √© 1.<br>
                        <strong>Regra 3:</strong> Arrays com menos dimens√µes ganham 1s √† esquerda.
                    </div>

                    <pre><code><span class="comment"># Exemplo: shape (3,4) com shape (4,)</span>
A = np.<span class="function">ones</span>((<span class="number">3</span>, <span class="number">4</span>))    <span class="comment"># Shape: (3, 4)</span>
b = np.<span class="function">array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])  <span class="comment"># Shape: (4,) ‚Üí tratado como (1, 4)</span>

C = A + b  <span class="comment"># b √© "esticado" para cada linha de A</span>
<span class="comment"># [[2, 3, 4, 5],</span>
<span class="comment">#  [2, 3, 4, 5],</span>
<span class="comment">#  [2, 3, 4, 5]]</span>

<span class="comment"># Exemplo: shape (3,1) com shape (1,4)</span>
A = np.<span class="function">array</span>([[<span class="number">1</span>], [<span class="number">2</span>], [<span class="number">3</span>]])  <span class="comment"># Shape: (3, 1)</span>
B = np.<span class="function">array</span>([[<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>]])  <span class="comment"># Shape: (1, 4)</span>

C = A + B  <span class="comment"># Ambos s√£o "esticados"</span>
<span class="comment"># [[11, 21, 31, 41],</span>
<span class="comment">#  [12, 22, 32, 42],</span>
<span class="comment">#  [13, 23, 33, 43]]</span>
</code></pre>

                    <h4>Padr√µes √öteis de Broadcasting</h4>
                    <pre><code><span class="comment"># Centralizar linhas (subtrair m√©dia de cada linha)</span>
matriz = np.<span class="function">array</span>([[<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>],
                    [<span class="number">40</span>, <span class="number">50</span>, <span class="number">60</span>]])

media_linhas = matriz.<span class="function">mean</span>(axis=<span class="number">1</span>, keepdims=<span class="keyword">True</span>)  <span class="comment"># [[20], [50]]</span>
centralizado = matriz - media_linhas
<span class="comment"># [[-10, 0, 10],</span>
<span class="comment">#  [-10, 0, 10]]</span>

<span class="comment"># Multiplica√ß√£o outer product</span>
a = np.<span class="function">array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])
b = np.<span class="function">array</span>([<span class="number">10</span>, <span class="number">20</span>])

<span class="comment"># Usando broadcasting</span>
outer = a[:, np.newaxis] * b  <span class="comment"># Shape: (3,1) * (2,) ‚Üí (3,2)</span>
<span class="comment"># [[10, 20],</span>
<span class="comment">#  [20, 40],</span>
<span class="comment">#  [30, 60]]</span>

<span class="comment"># Matriz de dist√¢ncias (muito √∫til!)</span>
pontos = np.<span class="function">array</span>([[<span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">1</span>], [<span class="number">2</span>, <span class="number">0</span>]])  <span class="comment"># 3 pontos 2D</span>
<span class="comment"># Shape: (3, 2)</span>

<span class="comment"># Diferen√ßa entre cada par de pontos</span>
diff = pontos[:, np.newaxis, :] - pontos[np.newaxis, :, :]
<span class="comment"># Shape: (3, 1, 2) - (1, 3, 2) ‚Üí (3, 3, 2)</span>

dist = np.<span class="function">sqrt</span>((diff ** <span class="number">2</span>).<span class="function">sum</span>(axis=<span class="number">2</span>))  <span class="comment"># Shape: (3, 3)</span>
</code></pre>

                    <div class="warning">
                        <strong>Erro comum:</strong> Broadcasting falha se as dimens√µes n√£o s√£o compat√≠veis. Use
                        <code>.reshape()</code> ou <code>np.newaxis</code> para ajustar shapes.
                    </div>

                    <!-- EXERC√çCIO 14 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 14</span>
                            <span class="exercise-title">Tabela de Multiplica√ß√£o</span>
                            <span class="difficulty easy">F√°cil</span>
                        </div>
                        <p>Crie uma tabela de multiplica√ß√£o 10x10 usando broadcasting (sem loops!).</p>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># Criar vetores de 1 a 10</span>
linha = np.<span class="function">arange</span>(<span class="number">1</span>, <span class="number">11</span>)  <span class="comment"># Shape: (10,)</span>
coluna = np.<span class="function">arange</span>(<span class="number">1</span>, <span class="number">11</span>).<span class="function">reshape</span>(<span class="number">10</span>, <span class="number">1</span>)  <span class="comment"># Shape: (10, 1)</span>

<span class="comment"># Broadcasting: (10, 1) * (10,) ‚Üí (10, 10)</span>
tabela = coluna * linha

<span class="comment"># Ou usando np.newaxis</span>
tabela_v2 = np.<span class="function">arange</span>(<span class="number">1</span>, <span class="number">11</span>)[:, np.newaxis] * np.<span class="function">arange</span>(<span class="number">1</span>, <span class="number">11</span>)

<span class="comment"># Ou usando np.outer</span>
tabela_v3 = np.<span class="function">outer</span>(np.<span class="function">arange</span>(<span class="number">1</span>, <span class="number">11</span>), np.<span class="function">arange</span>(<span class="number">1</span>, <span class="number">11</span>))

<span class="function">print</span>(tabela)
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 15 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 15</span>
                            <span class="exercise-title">Matriz de Dist√¢ncias Euclidianas</span>
                            <span class="difficulty hard">Dif√≠cil</span>
                        </div>
                        <p>Calcule a matriz de dist√¢ncias euclidianas entre todos os pares de pontos.</p>
                        <pre><code><span class="comment"># 5 pontos em 3 dimens√µes</span>
pontos = np.<span class="function">array</span>([
    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],
    [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],
    [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],
    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>],
    [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]
])

<span class="comment"># Resultado esperado: matriz 5x5 com dist√¢ncias</span>
<span class="comment"># dist[i,j] = dist√¢ncia entre ponto i e ponto j</span>
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># M√©todo 1: Broadcasting puro</span>
<span class="comment"># pontos shape: (5, 3)</span>
<span class="comment"># Queremos: (5, 5, 3) - (5, 5, 3) ‚Üí (5, 5, 3)</span>

diff = pontos[:, np.newaxis, :] - pontos[np.newaxis, :, :]
<span class="comment"># pontos[:, np.newaxis, :] ‚Üí shape (5, 1, 3)</span>
<span class="comment"># pontos[np.newaxis, :, :] ‚Üí shape (1, 5, 3)</span>
<span class="comment"># resultado ‚Üí shape (5, 5, 3)</span>

dist = np.<span class="function">sqrt</span>((diff ** <span class="number">2</span>).<span class="function">sum</span>(axis=<span class="number">2</span>))

<span class="comment"># M√©todo 2: F√≥rmula expandida (mais eficiente em mem√≥ria)</span>
<span class="comment"># ||a - b||¬≤ = ||a||¬≤ + ||b||¬≤ - 2*a¬∑b</span>
sq_norms = (pontos ** <span class="number">2</span>).<span class="function">sum</span>(axis=<span class="number">1</span>)
dot_product = pontos @ pontos.T
dist_v2 = np.<span class="function">sqrt</span>(sq_norms[:, np.newaxis] + sq_norms - <span class="number">2</span> * dot_product)

<span class="function">print</span>(dist.<span class="function">round</span>(<span class="number">2</span>))
<span class="comment"># [[0.   1.   1.   1.   1.73]</span>
<span class="comment">#  [1.   0.   1.41 1.41 1.41]</span>
<span class="comment">#  ...]</span>
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pr√≥ximas se√ß√µes ser√£o adicionadas... -->

                <!-- 2.3 MEM√ìRIA E RECURSOS AVAN√áADOS -->
                <div class="section">
                    <h3>2.3 Gerenciamento de Mem√≥ria e Recursos Avan√ßados</h3>

                    <p>Entender como NumPy gerencia mem√≥ria √© crucial para performance em dados grandes.</p>

                    <h4>Views vs Copies</h4>
                    <pre><code><span class="keyword">import</span> numpy <span class="keyword">as</span> np

arr = np.<span class="function">array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])

<span class="comment"># View: mesmo buffer de mem√≥ria</span>
view = arr[<span class="number">1</span>:<span class="number">4</span>]     <span class="comment"># Slicing cria view</span>
view[<span class="number">0</span>] = <span class="number">99</span>         <span class="comment"># Altera arr tamb√©m!</span>
<span class="function">print</span>(arr)           <span class="comment"># [1, 99, 3, 4, 5]</span>

<span class="comment"># Copy: buffer separado</span>
copy = arr.<span class="function">copy</span>()
copy[<span class="number">0</span>] = <span class="number">0</span>          <span class="comment"># N√£o afeta arr</span>

<span class="comment"># Verificar se √© view</span>
<span class="function">print</span>(view.base <span class="keyword">is</span> arr)   <span class="comment"># True (√© view)</span>
<span class="function">print</span>(copy.base <span class="keyword">is</span> <span class="keyword">None</span>)  <span class="comment"># True (√© copy)</span>

<span class="comment"># Opera√ß√µes que criam VIEWS: slicing, reshape, transpose</span>
<span class="comment"># Opera√ß√µes que criam COPIES: fancy indexing, boolean indexing</span>
</code></pre>

                    <h4>Fancy Indexing</h4>
                    <pre><code><span class="comment"># Sele√ß√£o com array de √≠ndices</span>
arr = np.<span class="function">array</span>([<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>])
indices = np.<span class="function">array</span>([<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>])

<span class="function">print</span>(arr[indices])  <span class="comment"># [10, 30, 50] - CRIA COPY!</span>

<span class="comment"># Boolean indexing</span>
mascara = arr > <span class="number">25</span>
<span class="function">print</span>(arr[mascara])  <span class="comment"># [30, 40, 50] - CRIA COPY!</span>

<span class="comment"># Combinando √≠ndices 2D</span>
matriz = np.<span class="function">arange</span>(<span class="number">12</span>).<span class="function">reshape</span>(<span class="number">3</span>, <span class="number">4</span>)
<span class="comment"># [[0, 1, 2, 3],</span>
<span class="comment">#  [4, 5, 6, 7],</span>
<span class="comment">#  [8, 9, 10, 11]]</span>

<span class="comment"># Selecionar elementos [0,1], [1,2], [2,3]</span>
linhas = np.<span class="function">array</span>([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>])
colunas = np.<span class="function">array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])
<span class="function">print</span>(matriz[linhas, colunas])  <span class="comment"># [1, 6, 11]</span>
</code></pre>

                    <h4>Dtypes Personalizados (Structured Arrays)</h4>
                    <pre><code><span class="comment"># Definir tipo estruturado (como uma tabela)</span>
dt = np.<span class="function">dtype</span>([
    (<span class="string">'nome'</span>, <span class="string">'U20'</span>),       <span class="comment"># String at√© 20 chars</span>
    (<span class="string">'idade'</span>, <span class="string">'i4'</span>),       <span class="comment"># Int 32-bit</span>
    (<span class="string">'salario'</span>, <span class="string">'f8'</span>)      <span class="comment"># Float 64-bit</span>
])

<span class="comment"># Criar array estruturado</span>
funcionarios = np.<span class="function">array</span>([
    (<span class="string">'Ana'</span>, <span class="number">30</span>, <span class="number">5000.0</span>),
    (<span class="string">'Bruno'</span>, <span class="number">25</span>, <span class="number">4500.0</span>),
    (<span class="string">'Carlos'</span>, <span class="number">35</span>, <span class="number">6000.0</span>)
], dtype=dt)

<span class="comment"># Acessar campos</span>
<span class="function">print</span>(funcionarios[<span class="string">'nome'</span>])     <span class="comment"># ['Ana', 'Bruno', 'Carlos']</span>
<span class="function">print</span>(funcionarios[<span class="string">'salario'</span>].<span class="function">mean</span>())  <span class="comment"># 5166.67</span>

<span class="comment"># Filtrar</span>
seniores = funcionarios[funcionarios[<span class="string">'idade'</span>] > <span class="number">28</span>]
</code></pre>

                    <h4>Fun√ß√µes de Alta Performance</h4>
                    <pre><code><span class="comment"># np.einsum - Einstein summation (muito poderoso!)</span>
A = np.<span class="function">random.random</span>((<span class="number">3</span>, <span class="number">4</span>))
B = np.<span class="function">random.random</span>((<span class="number">4</span>, <span class="number">5</span>))

<span class="comment"># Multiplica√ß√£o de matrizes</span>
C = np.<span class="function">einsum</span>(<span class="string">'ij,jk->ik'</span>, A, B)  <span class="comment"># Equivalente a A @ B</span>

<span class="comment"># Tra√ßo de uma matriz</span>
trace = np.<span class="function">einsum</span>(<span class="string">'ii->'</span>, np.<span class="function">eye</span>(<span class="number">4</span>))  <span class="comment"># 4.0</span>

<span class="comment"># Soma de elementos na diagonal</span>
diag_sum = np.<span class="function">einsum</span>(<span class="string">'ii->i'</span>, np.<span class="function">arange</span>(<span class="number">16</span>).<span class="function">reshape</span>(<span class="number">4</span>,<span class="number">4</span>))

<span class="comment"># np.tensordot para produtos tensoriais</span>
<span class="comment"># np.linalg para √°lgebra linear (inv, eig, svd, etc.)</span>
</code></pre>

                    <div class="tip">
                        <strong>Performance tip:</strong> Use <code>np.ascontiguousarray()</code> antes de opera√ß√µes
                        intensivas se seu array pode ter sido criado por slicing ou transpose.
                    </div>

                    <!-- EXERC√çCIO 16 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 16</span>
                            <span class="exercise-title">Views e Copies</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Dado o c√≥digo abaixo, preveja a sa√≠da de cada print sem executar.</p>
                        <pre><code>arr = np.<span class="function">arange</span>(<span class="number">10</span>)
a = arr[<span class="number">2</span>:<span class="number">5</span>]
b = arr[[<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]]

a[<span class="number">0</span>] = <span class="number">100</span>
b[<span class="number">0</span>] = <span class="number">200</span>

<span class="function">print</span>(arr)
<span class="function">print</span>(a)
<span class="function">print</span>(b)
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># arr = [0, 1, 100, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="comment"># Porque: a √© VIEW de arr, ent√£o a[0]=100 modifica arr[2]</span>

<span class="comment"># a = [100, 3, 4]</span>
<span class="comment"># Porque: a aponta para arr[2:5] que agora √© [100, 3, 4]</span>

<span class="comment"># b = [200, 3, 4]</span>
<span class="comment"># Porque: b √© COPY (fancy indexing), b[0]=200 n√£o afeta arr</span>
<span class="comment"># arr[2] continua sendo 100, n√£o 200</span>

<span class="comment"># LI√á√ÉO: Slicing ‚Üí View, Fancy indexing ‚Üí Copy</span>
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 17 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 17</span>
                            <span class="exercise-title">K Maiores Valores por Linha</span>
                            <span class="difficulty hard">Dif√≠cil</span>
                        </div>
                        <p>Encontre os 3 maiores valores de cada linha de uma matriz, usando apenas NumPy.</p>
                        <pre><code>matriz = np.<span class="function">random.randint</span>(<span class="number">0</span>, <span class="number">100</span>, size=(<span class="number">4</span>, <span class="number">10</span>))
<span class="comment"># Exemplo:</span>
<span class="comment"># [[23, 67, 45, 12, 89, 34, 56, 78, 90, 11],</span>
<span class="comment">#  ...]</span>

<span class="comment"># Retornar: top 3 valores de cada linha (4, 3)</span>
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># M√©todo 1: np.partition (mais eficiente, O(n))</span>
k = <span class="number">3</span>
<span class="comment"># partition coloca os k maiores no final</span>
particionado = np.<span class="function">partition</span>(matriz, -k, axis=<span class="number">1</span>)[:, -k:]
<span class="comment"># Ordenar os k valores</span>
top_k = np.<span class="function">sort</span>(particionado, axis=<span class="number">1</span>)[:, ::-<span class="number">1</span>]

<span class="comment"># M√©todo 2: np.argsort (mais flex√≠vel)</span>
indices = np.<span class="function">argsort</span>(matriz, axis=<span class="number">1</span>)[:, -k:][::, ::-<span class="number">1</span>]
<span class="comment"># Usar fancy indexing para pegar valores</span>
linhas = np.<span class="function">arange</span>(matriz.shape[<span class="number">0</span>])[:, np.newaxis]
top_k_v2 = matriz[linhas, indices]

<span class="function">print</span>(<span class="string">"Top 3 por linha:"</span>)
<span class="function">print</span>(top_k)

<span class="comment"># Bonus: √≠ndices dos top k</span>
<span class="function">print</span>(<span class="string">"√çndices dos top 3:"</span>)
<span class="function">print</span>(np.<span class="function">argsort</span>(matriz, axis=<span class="number">1</span>)[:, -k:][:, ::-<span class="number">1</span>])
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 18 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 18</span>
                            <span class="exercise-title">Convolu√ß√£o 1D Manual</span>
                            <span class="difficulty hard">Dif√≠cil</span>
                        </div>
                        <p>Implemente uma m√©dia m√≥vel de tamanho 3 usando apenas opera√ß√µes vetorizadas (sem rolling do
                            pandas, sem loops).</p>
                        <pre><code>dados = np.<span class="function">array</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>])
<span class="comment"># Esperado: m√©dia de janela 3 (v√°lida, sem padding)</span>
<span class="comment"># [2, 3, 4, 5, 6, 7, 8, 9]</span>
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="comment"># M√©todo 1: np.convolve</span>
janela = <span class="number">3</span>
kernel = np.<span class="function">ones</span>(janela) / janela
media_movel = np.<span class="function">convolve</span>(dados, kernel, mode=<span class="string">'valid'</span>)
<span class="function">print</span>(media_movel)  <span class="comment"># [2. 3. 4. 5. 6. 7. 8. 9.]</span>

<span class="comment"># M√©todo 2: Usando cumsum (muito eficiente!)</span>
cumsum = np.<span class="function">cumsum</span>(np.<span class="function">insert</span>(dados, <span class="number">0</span>, <span class="number">0</span>))
<span class="comment"># cumsum = [0, 1, 3, 6, 10, 15, 21, 28, 36, 45, 55]</span>
media_movel_v2 = (cumsum[janela:] - cumsum[:-janela]) / janela
<span class="function">print</span>(media_movel_v2)  <span class="comment"># [2. 3. 4. 5. 6. 7. 8. 9.]</span>

<span class="comment"># M√©todo 3: Stacking de views (as_strided - avan√ßado)</span>
<span class="keyword">from</span> numpy.lib.stride_tricks <span class="keyword">import</span> sliding_window_view
janelas = <span class="function">sliding_window_view</span>(dados, janela)
media_movel_v3 = janelas.<span class="function">mean</span>(axis=<span class="number">1</span>)
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- M√ìDULO 3: DADOS EM ESCALA -->
        <div class="module" id="modulo3">
            <div class="module-header">
                <h2>üìà M√≥dulo 3: Dados em Escala</h2>
            </div>
            <div class="module-content">
                <!-- 3.1 PROCESSAMENTO EM CHUNKS -->
                <div class="section">
                    <h3>3.1 Processamento em Chunks</h3>

                    <p>Quando dados n√£o cabem na mem√≥ria, processe em peda√ßos (chunks).</p>

                    <h4>Leitura em Chunks com Pandas</h4>
                    <pre><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd

<span class="comment"># Ler arquivo grande em chunks</span>
chunksize = <span class="number">100000</span>  <span class="comment"># Linhas por chunk</span>

<span class="comment"># Padr√£o: processar e agregar</span>
resultados = []
<span class="keyword">for</span> chunk <span class="keyword">in</span> pd.<span class="function">read_csv</span>(<span class="string">'dados_grandes.csv'</span>, chunksize=chunksize):
    <span class="comment"># Filtrar</span>
    chunk = chunk[chunk[<span class="string">'valor'</span>] > <span class="number">0</span>]
    <span class="comment"># Agregar</span>
    agg = chunk.<span class="function">groupby</span>(<span class="string">'categoria'</span>)[<span class="string">'valor'</span>].<span class="function">sum</span>()
    resultados.<span class="function">append</span>(agg)

<span class="comment"># Combinar resultados</span>
final = pd.<span class="function">concat</span>(resultados).<span class="function">groupby</span>(level=<span class="number">0</span>).<span class="function">sum</span>()

<span class="comment"># Par√¢metros √∫teis de read_csv</span>
df = pd.<span class="function">read_csv</span>(
    <span class="string">'arquivo.csv'</span>,
    usecols=[<span class="string">'col1'</span>, <span class="string">'col2'</span>],     <span class="comment"># S√≥ colunas necess√°rias</span>
    dtype={<span class="string">'id'</span>: <span class="string">'int32'</span>},         <span class="comment"># Tipos otimizados</span>
    parse_dates=[<span class="string">'data'</span>],          <span class="comment"># Parse de datas</span>
    nrows=<span class="number">1000</span>                      <span class="comment"># Limitar linhas (teste)</span>
)
</code></pre>

                    <h4>Padr√£o MapReduce em Chunks</h4>
                    <pre><code><span class="keyword">def</span> <span class="function">process_in_chunks</span>(filepath, chunksize=<span class="number">100000</span>):
    <span class="string">"""Padr√£o gen√©rico para processamento em chunks"""</span>
    
    <span class="comment"># Acumuladores</span>
    total_rows = <span class="number">0</span>
    soma_total = <span class="number">0</span>
    categorias = {}
    
    <span class="keyword">for</span> chunk <span class="keyword">in</span> pd.<span class="function">read_csv</span>(filepath, chunksize=chunksize):
        <span class="comment"># MAP: processar chunk</span>
        total_rows += <span class="function">len</span>(chunk)
        soma_total += chunk[<span class="string">'valor'</span>].<span class="function">sum</span>()
        
        <span class="comment"># REDUCE: agregar por categoria</span>
        <span class="keyword">for</span> cat, valor <span class="keyword">in</span> chunk.<span class="function">groupby</span>(<span class="string">'categoria'</span>)[<span class="string">'valor'</span>].<span class="function">sum</span>().<span class="function">items</span>():
            categorias[cat] = categorias.<span class="function">get</span>(cat, <span class="number">0</span>) + valor
    
    <span class="keyword">return</span> {
        <span class="string">'total_rows'</span>: total_rows,
        <span class="string">'soma_total'</span>: soma_total,
        <span class="string">'media'</span>: soma_total / total_rows,
        <span class="string">'por_categoria'</span>: categorias
    }
</code></pre>

                    <h4>Escrevendo em Chunks</h4>
                    <pre><code><span class="comment"># Append para arquivo existente</span>
<span class="keyword">for</span> i, chunk <span class="keyword">in</span> <span class="function">enumerate</span>(chunks):
    mode = <span class="string">'w'</span> <span class="keyword">if</span> i == <span class="number">0</span> <span class="keyword">else</span> <span class="string">'a'</span>
    header = (i == <span class="number">0</span>)  <span class="comment"># Header s√≥ no primeiro</span>
    chunk.<span class="function">to_csv</span>(<span class="string">'output.csv'</span>, mode=mode, header=header, index=<span class="keyword">False</span>)

<span class="comment"># Ou usar Parquet (muito mais eficiente!)</span>
df.<span class="function">to_parquet</span>(<span class="string">'dados.parquet'</span>, engine=<span class="string">'pyarrow'</span>)
df_loaded = pd.<span class="function">read_parquet</span>(<span class="string">'dados.parquet'</span>)
</code></pre>

                    <div class="tip">
                        <strong>Dica:</strong> Use <code>Parquet</code> em vez de CSV para dados grandes. √â ~10x mais
                        r√°pido e usa ~80% menos espa√ßo.
                    </div>

                    <!-- EXERC√çCIO 19 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 19</span>
                            <span class="exercise-title">Estat√≠sticas em Streaming</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Implemente uma fun√ß√£o que calcule m√©dia, desvio padr√£o e mediana de um arquivo grande de
                            forma eficiente em mem√≥ria (usando um √∫nico pass pelos dados quando poss√≠vel).</p>
                        <pre><code><span class="comment"># Dica: Para m√©dia/std use algoritmo de Welford</span>
<span class="comment"># Para mediana, considere aproxima√ß√£o ou t-digest</span>
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">import</span> numpy <span class="keyword">as</span> np

<span class="keyword">class</span> <span class="function">StreamingStats</span>:
    <span class="string">"""Estat√≠sticas online (Welford's algorithm)"""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(self):
        self.n = <span class="number">0</span>
        self.mean = <span class="number">0</span>
        self.M2 = <span class="number">0</span>  <span class="comment"># Para vari√¢ncia</span>
        self.min_val = <span class="keyword">float</span>(<span class="string">'inf'</span>)
        self.max_val = <span class="keyword">float</span>(<span class="string">'-inf'</span>)
        self.reservoir = []  <span class="comment"># Para mediana aproximada</span>
        self.reservoir_size = <span class="number">10000</span>
    
    <span class="keyword">def</span> <span class="function">update</span>(self, values):
        <span class="string">"""Atualiza com array de valores"""</span>
        <span class="keyword">for</span> x <span class="keyword">in</span> values:
            self.n += <span class="number">1</span>
            delta = x - self.mean
            self.mean += delta / self.n
            delta2 = x - self.mean
            self.M2 += delta * delta2
            
            self.min_val = <span class="function">min</span>(self.min_val, x)
            self.max_val = <span class="function">max</span>(self.max_val, x)
            
            <span class="comment"># Reservoir sampling para mediana</span>
            <span class="keyword">if</span> <span class="function">len</span>(self.reservoir) < self.reservoir_size:
                self.reservoir.<span class="function">append</span>(x)
            <span class="keyword">else</span>:
                j = np.<span class="function">random.randint</span>(<span class="number">0</span>, self.n)
                <span class="keyword">if</span> j < self.reservoir_size:
                    self.reservoir[j] = x
    
    <span class="keyword">def</span> <span class="function">get_stats</span>(self):
        <span class="keyword">return</span> {
            <span class="string">'count'</span>: self.n,
            <span class="string">'mean'</span>: self.mean,
            <span class="string">'std'</span>: np.<span class="function">sqrt</span>(self.M2 / self.n) <span class="keyword">if</span> self.n > <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>,
            <span class="string">'min'</span>: self.min_val,
            <span class="string">'max'</span>: self.max_val,
            <span class="string">'median_approx'</span>: np.<span class="function">median</span>(self.reservoir)
        }

<span class="comment"># Uso</span>
stats = <span class="function">StreamingStats</span>()
<span class="keyword">for</span> chunk <span class="keyword">in</span> pd.<span class="function">read_csv</span>(<span class="string">'grande.csv'</span>, chunksize=<span class="number">100000</span>):
    stats.<span class="function">update</span>(chunk[<span class="string">'valor'</span>].values)

<span class="function">print</span>(stats.<span class="function">get_stats</span>())
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3.2 POLARS E LAZY EVALUATION -->
                <div class="section">
                    <h3>3.2 Polars: A Alternativa Eficiente</h3>

                    <p>Polars √© uma biblioteca moderna em Rust, muito mais r√°pida que Pandas para dados grandes.</p>

                    <h4>B√°sico do Polars</h4>
                    <pre><code><span class="keyword">import</span> polars <span class="keyword">as</span> pl

<span class="comment"># Leitura (muito mais r√°pido!)</span>
df = pl.<span class="function">read_csv</span>(<span class="string">'dados.csv'</span>)
df = pl.<span class="function">read_parquet</span>(<span class="string">'dados.parquet'</span>)

<span class="comment"># Sintaxe similar ao Pandas mas com Expressions</span>
df.<span class="function">select</span>([
    pl.<span class="function">col</span>(<span class="string">'nome'</span>),
    pl.<span class="function">col</span>(<span class="string">'valor'</span>) * <span class="number">2</span>,
    (pl.<span class="function">col</span>(<span class="string">'preco'</span>) > <span class="number">100</span>).<span class="function">alias</span>(<span class="string">'caro'</span>)
])

<span class="comment"># Filtrar</span>
df.<span class="function">filter</span>(pl.<span class="function">col</span>(<span class="string">'valor'</span>) > <span class="number">100</span>)

<span class="comment"># GroupBy</span>
df.<span class="function">group_by</span>(<span class="string">'categoria'</span>).<span class="function">agg</span>([
    pl.<span class="function">col</span>(<span class="string">'valor'</span>).<span class="function">sum</span>().<span class="function">alias</span>(<span class="string">'total'</span>),
    pl.<span class="function">col</span>(<span class="string">'valor'</span>).<span class="function">mean</span>().<span class="function">alias</span>(<span class="string">'media'</span>),
    pl.<span class="function">col</span>(<span class="string">'id'</span>).<span class="function">count</span>().<span class="function">alias</span>(<span class="string">'n'</span>)
])
</code></pre>

                    <h4>Lazy Evaluation (O Poder do Polars)</h4>
                    <pre><code><span class="comment"># LazyFrame: constr√≥i query plan, s√≥ executa no collect()</span>
lf = pl.<span class="function">scan_csv</span>(<span class="string">'dados.csv'</span>)  <span class="comment"># N√£o l√™ ainda!</span>

<span class="comment"># Construir pipeline</span>
resultado = (
    lf
    .<span class="function">filter</span>(pl.<span class="function">col</span>(<span class="string">'ano'</span>) >= <span class="number">2020</span>)
    .<span class="function">with_columns</span>([
        (pl.<span class="function">col</span>(<span class="string">'valor'</span>) * <span class="number">1.1</span>).<span class="function">alias</span>(<span class="string">'valor_ajustado'</span>)
    ])
    .<span class="function">group_by</span>(<span class="string">'categoria'</span>)
    .<span class="function">agg</span>(pl.<span class="function">col</span>(<span class="string">'valor_ajustado'</span>).<span class="function">sum</span>())
    .<span class="function">sort</span>(<span class="string">'valor_ajustado'</span>, descending=<span class="keyword">True</span>)
)

<span class="comment"># Ver query plan otimizado</span>
<span class="function">print</span>(resultado.<span class="function">explain</span>())

<span class="comment"># Executar (agora l√™ e processa)</span>
df_final = resultado.<span class="function">collect</span>()
</code></pre>

                    <h4>Compara√ß√£o Pandas vs Polars</h4>
                    <table>
                        <tr>
                            <th>Aspecto</th>
                            <th>Pandas</th>
                            <th>Polars</th>
                        </tr>
                        <tr>
                            <td>Velocidade</td>
                            <td>1x</td>
                            <td>5-50x mais r√°pido</td>
                        </tr>
                        <tr>
                            <td>Mem√≥ria</td>
                            <td>Alta</td>
                            <td>Muito menor</td>
                        </tr>
                        <tr>
                            <td>Lazy eval</td>
                            <td>N√£o</td>
                            <td>Sim</td>
                        </tr>
                        <tr>
                            <td>Paralelismo</td>
                            <td>Manual</td>
                            <td>Autom√°tico</td>
                        </tr>
                        <tr>
                            <td>Ecossistema</td>
                            <td>Enorme</td>
                            <td>Crescendo</td>
                        </tr>
                        <tr>
                            <td>Curva aprendizado</td>
                            <td>F√°cil</td>
                            <td>M√©dio</td>
                        </tr>
                    </table>

                    <div class="note">
                        <strong>Quando usar Polars:</strong> Dados > 1GB, pipelines complexos, produ√ß√£o. <strong>Quando
                            usar Pandas:</strong> An√°lise explorat√≥ria, compatibilidade com outras libs.
                    </div>

                    <!-- EXERC√çCIO 20 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 20</span>
                            <span class="exercise-title">Pipeline ETL com Polars</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Converta o seguinte c√≥digo Pandas para Polars, aproveitando lazy evaluation.</p>
                        <pre><code><span class="comment"># C√≥digo Pandas</span>
df = pd.<span class="function">read_csv</span>(<span class="string">'vendas.csv'</span>)
df[<span class="string">'data'</span>] = pd.<span class="function">to_datetime</span>(df[<span class="string">'data'</span>])
df = df[df[<span class="string">'valor'</span>] > <span class="number">0</span>]
df[<span class="string">'mes'</span>] = df[<span class="string">'data'</span>].dt.month
resultado = df.<span class="function">groupby</span>([<span class="string">'loja'</span>, <span class="string">'mes'</span>]).<span class="function">agg</span>({
    <span class="string">'valor'</span>: [<span class="string">'sum'</span>, <span class="string">'mean'</span>, <span class="string">'count'</span>]
}).<span class="function">reset_index</span>()
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">import</span> polars <span class="keyword">as</span> pl

<span class="comment"># Vers√£o Polars com lazy evaluation</span>
resultado = (
    pl.<span class="function">scan_csv</span>(<span class="string">'vendas.csv'</span>)
    .<span class="function">with_columns</span>([
        pl.<span class="function">col</span>(<span class="string">'data'</span>).<span class="function">str.to_datetime</span>(<span class="string">'%Y-%m-%d'</span>)
    ])
    .<span class="function">filter</span>(pl.<span class="function">col</span>(<span class="string">'valor'</span>) > <span class="number">0</span>)
    .<span class="function">with_columns</span>([
        pl.<span class="function">col</span>(<span class="string">'data'</span>).dt.<span class="function">month</span>().<span class="function">alias</span>(<span class="string">'mes'</span>)
    ])
    .<span class="function">group_by</span>([<span class="string">'loja'</span>, <span class="string">'mes'</span>])
    .<span class="function">agg</span>([
        pl.<span class="function">col</span>(<span class="string">'valor'</span>).<span class="function">sum</span>().<span class="function">alias</span>(<span class="string">'valor_sum'</span>),
        pl.<span class="function">col</span>(<span class="string">'valor'</span>).<span class="function">mean</span>().<span class="function">alias</span>(<span class="string">'valor_mean'</span>),
        pl.<span class="function">col</span>(<span class="string">'valor'</span>).<span class="function">count</span>().<span class="function">alias</span>(<span class="string">'valor_count'</span>)
    ])
    .<span class="function">collect</span>()
)

<span class="comment"># Converter para Pandas se necess√°rio</span>
df_pandas = resultado.<span class="function">to_pandas</span>()
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3.3 SQL E DATABASES -->
                <div class="section">
                    <h3>3.3 SQL e Databases</h3>

                    <p>Para dados muito grandes, use um banco de dados e SQL para fazer o trabalho pesado.</p>

                    <h4>SQLite com Pandas</h4>
                    <pre><code><span class="keyword">import</span> sqlite3
<span class="keyword">import</span> pandas <span class="keyword">as</span> pd

<span class="comment"># Conectar</span>
conn = sqlite3.<span class="function">connect</span>(<span class="string">'database.db'</span>)

<span class="comment"># Ler SQL direto para DataFrame</span>
df = pd.<span class="function">read_sql</span>(<span class="string">'''
    SELECT categoria, SUM(valor) as total
    FROM vendas
    WHERE ano >= 2020
    GROUP BY categoria
    ORDER BY total DESC
'''</span>, conn)

<span class="comment"># Escrever DataFrame para SQL</span>
df.<span class="function">to_sql</span>(<span class="string">'tabela_nova'</span>, conn, if_exists=<span class="string">'replace'</span>, index=<span class="keyword">False</span>)

<span class="comment"># Ler em chunks do SQL</span>
<span class="keyword">for</span> chunk <span class="keyword">in</span> pd.<span class="function">read_sql</span>(<span class="string">'SELECT * FROM grande'</span>, conn, chunksize=<span class="number">100000</span>):
    <span class="comment"># processar chunk</span>
    <span class="keyword">pass</span>

conn.<span class="function">close</span>()
</code></pre>

                    <h4>DuckDB: SQL Anal√≠tico Embutido</h4>
                    <pre><code><span class="keyword">import</span> duckdb

<span class="comment"># DuckDB: processamento anal√≠tico ultra-r√°pido</span>
<span class="comment"># L√™ CSVs e Parquets diretamente!</span>

<span class="comment"># Query direto em arquivo</span>
df = duckdb.<span class="function">query</span>(<span class="string">"""
    SELECT 
        categoria,
        SUM(valor) as total,
        COUNT(*) as n
    FROM read_csv_auto('vendas/*.csv')
    WHERE ano >= 2020
    GROUP BY categoria
"""</span>).<span class="function">to_df</span>()

<span class="comment"># Query em DataFrames existentes</span>
vendas_df = pd.<span class="function">read_csv</span>(<span class="string">'vendas.csv'</span>)
resultado = duckdb.<span class="function">query</span>(<span class="string">"""
    SELECT loja, AVG(valor) as media
    FROM vendas_df
    GROUP BY loja
"""</span>).<span class="function">to_df</span>()

<span class="comment"># Usar Polars com DuckDB</span>
<span class="keyword">import</span> polars <span class="keyword">as</span> pl
resultado_pl = duckdb.<span class="function">query</span>(<span class="string">"SELECT * FROM vendas_df"</span>).<span class="function">pl</span>()
</code></pre>

                    <div class="tip">
                        <strong>DuckDB √© incr√≠vel para:</strong> An√°lise ad-hoc em arquivos grandes, queries SQL
                        complexas sem setup de servidor, integra√ß√£o Pandas/Polars.
                    </div>

                    <!-- EXERC√çCIO 21 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 21</span>
                            <span class="exercise-title">An√°lise com DuckDB</span>
                            <span class="difficulty easy">F√°cil</span>
                        </div>
                        <p>Use DuckDB para encontrar os top 5 produtos por categoria, ordenados por vendas totais.</p>
                        <pre><code><span class="comment"># Dados de exemplo</span>
vendas = pd.DataFrame({
    <span class="string">'produto'</span>: [<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>],
    <span class="string">'categoria'</span>: [<span class="string">'X'</span>, <span class="string">'X'</span>, <span class="string">'X'</span>, <span class="string">'Y'</span>, <span class="string">'Y'</span>, <span class="string">'Y'</span>, <span class="string">'X'</span>, <span class="string">'Y'</span>],
    <span class="string">'valor'</span>: [<span class="number">100</span>, <span class="number">200</span>, <span class="number">150</span>, <span class="number">300</span>, <span class="number">250</span>, <span class="number">180</span>, <span class="number">120</span>, <span class="number">90</span>]
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">import</span> duckdb

<span class="comment"># Top 5 produtos por categoria usando QUALIFY</span>
top_produtos = duckdb.<span class="function">query</span>(<span class="string">"""
    SELECT 
        categoria,
        produto,
        SUM(valor) as total,
        ROW_NUMBER() OVER (
            PARTITION BY categoria 
            ORDER BY SUM(valor) DESC
        ) as rank
    FROM vendas
    GROUP BY categoria, produto
    QUALIFY rank <= 5
    ORDER BY categoria, rank
"""</span>).<span class="function">to_df</span>()

<span class="function">print</span>(top_produtos)

<span class="comment"># Alternativa sem QUALIFY</span>
top_produtos_v2 = duckdb.<span class="function">query</span>(<span class="string">"""
    WITH ranked AS (
        SELECT 
            categoria, produto, SUM(valor) as total,
            ROW_NUMBER() OVER (PARTITION BY categoria ORDER BY SUM(valor) DESC) as rn
        FROM vendas
        GROUP BY categoria, produto
    )
    SELECT * FROM ranked WHERE rn <= 5
"""</span>).<span class="function">to_df</span>()
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- EXERC√çCIO 22 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 22</span>
                            <span class="exercise-title">Pipeline Completo em Escala</span>
                            <span class="difficulty hard">Dif√≠cil</span>
                        </div>
                        <p>Crie uma fun√ß√£o que processe um dataset grande (simulado) e demonstre o uso combinado de
                            t√©cnicas aprendidas.</p>
                        <pre><code><span class="comment"># Requisitos:</span>
<span class="comment"># 1. Gerar dados sint√©ticos de vendas (1M+ linhas)</span>
<span class="comment"># 2. Salvar em Parquet particionado por ano</span>
<span class="comment"># 3. Usar DuckDB para an√°lise agregada</span>
<span class="comment"># 4. Comparar tempo Pandas vs Polars vs DuckDB</span>
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> numpy <span class="keyword">as</span> np
<span class="keyword">import</span> time
<span class="keyword">import</span> os

<span class="keyword">def</span> <span class="function">gerar_dados</span>(n=<span class="number">1000000</span>):
    <span class="string">"""Gera dados sint√©ticos de vendas"""</span>
    np.random.<span class="function">seed</span>(<span class="number">42</span>)
    <span class="keyword">return</span> pd.DataFrame({
        <span class="string">'data'</span>: pd.<span class="function">date_range</span>(<span class="string">'2020-01-01'</span>, periods=n, freq=<span class="string">'min'</span>),
        <span class="string">'loja'</span>: np.random.<span class="function">choice</span>([<span class="string">'SP'</span>, <span class="string">'RJ'</span>, <span class="string">'MG'</span>, <span class="string">'RS'</span>], n),
        <span class="string">'produto'</span>: np.random.<span class="function">choice</span>([<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>], n),
        <span class="string">'valor'</span>: np.random.<span class="function">exponential</span>(<span class="number">100</span>, n).<span class="function">round</span>(<span class="number">2</span>),
        <span class="string">'quantidade'</span>: np.random.<span class="function">randint</span>(<span class="number">1</span>, <span class="number">10</span>, n)
    })

<span class="keyword">def</span> <span class="function">benchmark</span>(name, func):
    start = time.<span class="function">time</span>()
    result = <span class="function">func</span>()
    elapsed = time.<span class="function">time</span>() - start
    <span class="function">print</span>(<span class="string">f'{name}: {elapsed:.3f}s'</span>)
    <span class="keyword">return</span> result

<span class="comment"># 1. Gerar e salvar em Parquet</span>
df = <span class="function">gerar_dados</span>()
df[<span class="string">'ano'</span>] = df[<span class="string">'data'</span>].dt.year
df.<span class="function">to_parquet</span>(<span class="string">'vendas.parquet'</span>, partition_cols=[<span class="string">'ano'</span>])

<span class="comment"># 2. Benchmark Pandas</span>
<span class="keyword">def</span> <span class="function">analise_pandas</span>():
    df = pd.<span class="function">read_parquet</span>(<span class="string">'vendas.parquet'</span>)
    <span class="keyword">return</span> df.<span class="function">groupby</span>([<span class="string">'loja'</span>, <span class="string">'produto'</span>]).<span class="function">agg</span>({
        <span class="string">'valor'</span>: <span class="string">'sum'</span>, <span class="string">'quantidade'</span>: <span class="string">'sum'</span>
    })

<span class="comment"># 3. Benchmark Polars</span>
<span class="keyword">def</span> <span class="function">analise_polars</span>():
    <span class="keyword">import</span> polars <span class="keyword">as</span> pl
    <span class="keyword">return</span> (
        pl.<span class="function">scan_parquet</span>(<span class="string">'vendas.parquet'</span>)
        .<span class="function">group_by</span>([<span class="string">'loja'</span>, <span class="string">'produto'</span>])
        .<span class="function">agg</span>([pl.<span class="function">col</span>(<span class="string">'valor'</span>).<span class="function">sum</span>(), pl.<span class="function">col</span>(<span class="string">'quantidade'</span>).<span class="function">sum</span>()])
        .<span class="function">collect</span>()
    )

<span class="comment"># 4. Benchmark DuckDB</span>
<span class="keyword">def</span> <span class="function">analise_duckdb</span>():
    <span class="keyword">import</span> duckdb
    <span class="keyword">return</span> duckdb.<span class="function">query</span>(<span class="string">"""
        SELECT loja, produto, SUM(valor), SUM(quantidade)
        FROM read_parquet('vendas.parquet/*/*.parquet')
        GROUP BY loja, produto
    """</span>).<span class="function">to_df</span>()

<span class="function">benchmark</span>(<span class="string">'Pandas'</span>, analise_pandas)
<span class="function">benchmark</span>(<span class="string">'Polars'</span>, analise_polars)
<span class="function">benchmark</span>(<span class="string">'DuckDB'</span>, analise_duckdb)
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- M√ìDULO 4: VISUALIZA√á√ÉO AVAN√áADA -->
        <div class="module" id="modulo4">
            <div class="module-header">
                <h2>üé® M√≥dulo 4: Visualiza√ß√£o Avan√ßada</h2>
            </div>
            <div class="module-content">
                <!-- 4.1 MATPLOTLIB AVAN√áADO -->
                <div class="section">
                    <h3>4.1 Matplotlib Avan√ßado</h3>

                    <p>Matplotlib √© a base de quase toda visualiza√ß√£o em Python. Domine a API object-oriented!</p>

                    <h4>Figure e Axes: A API Correta</h4>
                    <pre><code><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

<span class="comment"># ‚ùå Pyplot impl√≠cito (ruim para customiza√ß√£o)</span>
plt.<span class="function">plot</span>(x, y)
plt.<span class="function">title</span>(<span class="string">'T√≠tulo'</span>)

<span class="comment"># ‚úÖ Object-oriented (recomendado)</span>
fig, ax = plt.<span class="function">subplots</span>(figsize=(<span class="number">10</span>, <span class="number">6</span>))
ax.<span class="function">plot</span>(x, y, color=<span class="string">'#2ecc71'</span>, linewidth=<span class="number">2</span>, label=<span class="string">'Dados'</span>)
ax.<span class="function">set_title</span>(<span class="string">'T√≠tulo'</span>, fontsize=<span class="number">14</span>, fontweight=<span class="string">'bold'</span>)
ax.<span class="function">set_xlabel</span>(<span class="string">'Eixo X'</span>)
ax.<span class="function">set_ylabel</span>(<span class="string">'Eixo Y'</span>)
ax.<span class="function">legend</span>()
ax.<span class="function">grid</span>(<span class="keyword">True</span>, alpha=<span class="number">0.3</span>)
</code></pre>

                    <h4>Subplots e Layouts</h4>
                    <pre><code><span class="comment"># Grid de subplots</span>
fig, axes = plt.<span class="function">subplots</span>(<span class="number">2</span>, <span class="number">3</span>, figsize=(<span class="number">15</span>, <span class="number">10</span>))

<span class="comment"># Acessar cada subplot</span>
axes[<span class="number">0</span>, <span class="number">0</span>].<span class="function">plot</span>(x, y)
axes[<span class="number">0</span>, <span class="number">1</span>].<span class="function">scatter</span>(x, y)
axes[<span class="number">1</span>, <span class="number">2</span>].<span class="function">bar</span>(categorias, valores)

<span class="comment"># Layout flex√≠vel com GridSpec</span>
fig = plt.<span class="function">figure</span>(figsize=(<span class="number">12</span>, <span class="number">8</span>))
gs = fig.<span class="function">add_gridspec</span>(<span class="number">3</span>, <span class="number">3</span>)

ax1 = fig.<span class="function">add_subplot</span>(gs[<span class="number">0</span>, :])     <span class="comment"># Primeira linha inteira</span>
ax2 = fig.<span class="function">add_subplot</span>(gs[<span class="number">1</span>:, <span class="number">0</span>])    <span class="comment"># Coluna esquerda (linhas 1-2)</span>
ax3 = fig.<span class="function">add_subplot</span>(gs[<span class="number">1</span>:, <span class="number">1</span>:])   <span class="comment"># Canto inferior direito</span>

plt.<span class="function">tight_layout</span>()
</code></pre>

                    <h4>Customiza√ß√£o Profissional</h4>
                    <pre><code><span class="comment"># Estilo global</span>
plt.style.<span class="function">use</span>(<span class="string">'seaborn-v0_8-whitegrid'</span>)  <span class="comment"># ou 'dark_background', 'ggplot'</span>

<span class="comment"># Paleta de cores personalizada</span>
cores = [<span class="string">'#3498db'</span>, <span class="string">'#e74c3c'</span>, <span class="string">'#2ecc71'</span>, <span class="string">'#f39c12'</span>, <span class="string">'#9b59b6'</span>]

<span class="comment"># Anota√ß√µes</span>
ax.<span class="function">annotate</span>(
    <span class="string">'Ponto importante!'</span>,
    xy=(<span class="number">5</span>, <span class="number">10</span>),              <span class="comment"># Ponto a anotar</span>
    xytext=(<span class="number">7</span>, <span class="number">15</span>),           <span class="comment"># Posi√ß√£o do texto</span>
    arrowprops=<span class="function">dict</span>(arrowstyle=<span class="string">'->'</span>, color=<span class="string">'black'</span>),
    fontsize=<span class="number">12</span>
)

<span class="comment"># Eixo secund√°rio</span>
ax2 = ax.<span class="function">twinx</span>()
ax2.<span class="function">plot</span>(x, y2, color=<span class="string">'red'</span>)
ax2.<span class="function">set_ylabel</span>(<span class="string">'Segundo Eixo Y'</span>, color=<span class="string">'red'</span>)

<span class="comment"># Salvar em alta qualidade</span>
fig.<span class="function">savefig</span>(<span class="string">'grafico.png'</span>, dpi=<span class="number">300</span>, bbox_inches=<span class="string">'tight'</span>, facecolor=<span class="string">'white'</span>)
</code></pre>

                    <div class="tip">
                        <strong>Dica:</strong> Use <code>fig.tight_layout()</code> ou
                        <code>plt.constrained_layout=True</code> para evitar sobreposi√ß√£o de elementos.
                    </div>

                    <!-- EXERC√çCIO 23 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 23</span>
                            <span class="exercise-title">Dashboard com Subplots</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Crie um dashboard com 4 gr√°ficos mostrando diferentes aspectos de dados de vendas.</p>
                        <pre><code><span class="comment"># Dados de exemplo</span>
np.random.<span class="function">seed</span>(<span class="number">42</span>)
meses = [<span class="string">'Jan'</span>, <span class="string">'Fev'</span>, <span class="string">'Mar'</span>, <span class="string">'Abr'</span>, <span class="string">'Mai'</span>, <span class="string">'Jun'</span>]
vendas = np.random.<span class="function">randint</span>(<span class="number">100</span>, <span class="number">500</span>, <span class="number">6</span>)
categorias = [<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>]
valores_cat = np.random.<span class="function">randint</span>(<span class="number">50</span>, <span class="number">200</span>, <span class="number">4</span>)
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

np.random.<span class="function">seed</span>(<span class="number">42</span>)
meses = [<span class="string">'Jan'</span>, <span class="string">'Fev'</span>, <span class="string">'Mar'</span>, <span class="string">'Abr'</span>, <span class="string">'Mai'</span>, <span class="string">'Jun'</span>]
vendas = np.random.<span class="function">randint</span>(<span class="number">100</span>, <span class="number">500</span>, <span class="number">6</span>)
categorias = [<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>]
valores_cat = np.random.<span class="function">randint</span>(<span class="number">50</span>, <span class="number">200</span>, <span class="number">4</span>)

fig, axes = plt.<span class="function">subplots</span>(<span class="number">2</span>, <span class="number">2</span>, figsize=(<span class="number">12</span>, <span class="number">10</span>))
cores = [<span class="string">'#3498db'</span>, <span class="string">'#e74c3c'</span>, <span class="string">'#2ecc71'</span>, <span class="string">'#f39c12'</span>]

<span class="comment"># 1. Linha de tend√™ncia</span>
axes[<span class="number">0</span>, <span class="number">0</span>].<span class="function">plot</span>(meses, vendas, marker=<span class="string">'o'</span>, color=cores[<span class="number">0</span>], linewidth=<span class="number">2</span>)
axes[<span class="number">0</span>, <span class="number">0</span>].<span class="function">fill_between</span>(meses, vendas, alpha=<span class="number">0.3</span>)
axes[<span class="number">0</span>, <span class="number">0</span>].<span class="function">set_title</span>(<span class="string">'Vendas por M√™s'</span>, fontweight=<span class="string">'bold'</span>)
axes[<span class="number">0</span>, <span class="number">0</span>].<span class="function">set_ylabel</span>(<span class="string">'Vendas (R$)'</span>)

<span class="comment"># 2. Barras por categoria</span>
axes[<span class="number">0</span>, <span class="number">1</span>].<span class="function">bar</span>(categorias, valores_cat, color=cores)
axes[<span class="number">0</span>, <span class="number">1</span>].<span class="function">set_title</span>(<span class="string">'Vendas por Categoria'</span>, fontweight=<span class="string">'bold'</span>)

<span class="comment"># 3. Pizza</span>
axes[<span class="number">1</span>, <span class="number">0</span>].<span class="function">pie</span>(valores_cat, labels=categorias, colors=cores, 
              autopct=<span class="string">'%1.1f%%'</span>, explode=[<span class="number">0.05</span>]*<span class="number">4</span>)
axes[<span class="number">1</span>, <span class="number">0</span>].<span class="function">set_title</span>(<span class="string">'Distribui√ß√£o'</span>, fontweight=<span class="string">'bold'</span>)

<span class="comment"># 4. Histograma</span>
dados = np.random.<span class="function">normal</span>(<span class="number">300</span>, <span class="number">100</span>, <span class="number">1000</span>)
axes[<span class="number">1</span>, <span class="number">1</span>].<span class="function">hist</span>(dados, bins=<span class="number">30</span>, color=cores[<span class="number">2</span>], edgecolor=<span class="string">'white'</span>)
axes[<span class="number">1</span>, <span class="number">1</span>].<span class="function">set_title</span>(<span class="string">'Distribui√ß√£o de Valores'</span>, fontweight=<span class="string">'bold'</span>)

fig.<span class="function">suptitle</span>(<span class="string">'Dashboard de Vendas'</span>, fontsize=<span class="number">16</span>, fontweight=<span class="string">'bold'</span>)
plt.<span class="function">tight_layout</span>()
plt.<span class="function">show</span>()
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4.2 SEABORN -->
                <div class="section">
                    <h3>4.2 Seaborn: Visualiza√ß√£o Estat√≠stica</h3>

                    <p>Seaborn simplifica gr√°ficos estat√≠sticos e funciona perfeitamente com DataFrames.</p>

                    <h4>Gr√°ficos de Distribui√ß√£o</h4>
                    <pre><code><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns
<span class="keyword">import</span> pandas <span class="keyword">as</span> pd

<span class="comment"># Configurar estilo</span>
sns.<span class="function">set_theme</span>(style=<span class="string">'whitegrid'</span>, palette=<span class="string">'husl'</span>)

<span class="comment"># Histograma + KDE</span>
sns.<span class="function">histplot</span>(data=df, x=<span class="string">'valor'</span>, hue=<span class="string">'categoria'</span>, kde=<span class="keyword">True</span>)

<span class="comment"># Box plot</span>
sns.<span class="function">boxplot</span>(data=df, x=<span class="string">'categoria'</span>, y=<span class="string">'valor'</span>, palette=<span class="string">'Set2'</span>)

<span class="comment"># Violin plot (box + KDE)</span>
sns.<span class="function">violinplot</span>(data=df, x=<span class="string">'categoria'</span>, y=<span class="string">'valor'</span>, inner=<span class="string">'box'</span>)

<span class="comment"># Ridge plot com FacetGrid</span>
g = sns.<span class="function">FacetGrid</span>(df, row=<span class="string">'categoria'</span>, aspect=<span class="number">4</span>, height=<span class="number">1.5</span>)
g.<span class="function">map</span>(sns.kdeplot, <span class="string">'valor'</span>, fill=<span class="keyword">True</span>)
</code></pre>

                    <h4>Gr√°ficos de Rela√ß√£o</h4>
                    <pre><code><span class="comment"># Scatter com regress√£o</span>
sns.<span class="function">regplot</span>(data=df, x=<span class="string">'x'</span>, y=<span class="string">'y'</span>, scatter_kws={<span class="string">'alpha'</span>: <span class="number">0.5</span>})

<span class="comment"># Scatter colorido por categoria</span>
sns.<span class="function">scatterplot</span>(data=df, x=<span class="string">'x'</span>, y=<span class="string">'y'</span>, hue=<span class="string">'categoria'</span>, size=<span class="string">'valor'</span>)

<span class="comment"># Pair plot (matriz de scatter)</span>
sns.<span class="function">pairplot</span>(df, hue=<span class="string">'categoria'</span>, diag_kind=<span class="string">'kde'</span>)

<span class="comment"># Heatmap de correla√ß√£o</span>
correlacao = df.<span class="function">corr</span>()
sns.<span class="function">heatmap</span>(correlacao, annot=<span class="keyword">True</span>, cmap=<span class="string">'coolwarm'</span>, center=<span class="number">0</span>,
            fmt=<span class="string">'.2f'</span>, square=<span class="keyword">True</span>, linewidths=<span class="number">0.5</span>)
</code></pre>

                    <h4>Gr√°ficos Categ√≥ricos</h4>
                    <pre><code><span class="comment"># Countplot (frequ√™ncia)</span>
sns.<span class="function">countplot</span>(data=df, x=<span class="string">'categoria'</span>, order=df[<span class="string">'categoria'</span>].<span class="function">value_counts</span>().index)

<span class="comment"># Barplot com erro</span>
sns.<span class="function">barplot</span>(data=df, x=<span class="string">'categoria'</span>, y=<span class="string">'valor'</span>, estimator=<span class="string">'mean'</span>, errorbar=<span class="string">'sd'</span>)

<span class="comment"># Catplot (FacetGrid com gr√°ficos categ√≥ricos)</span>
g = sns.<span class="function">catplot</span>(data=df, x=<span class="string">'mes'</span>, y=<span class="string">'valor'</span>, hue=<span class="string">'categoria'</span>, 
               col=<span class="string">'ano'</span>, kind=<span class="string">'bar'</span>, height=<span class="number">4</span>)
</code></pre>

                    <!-- EXERC√çCIO 24 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 24</span>
                            <span class="exercise-title">An√°lise Explorat√≥ria Visual</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Crie uma an√°lise visual completa do dataset tips do Seaborn.</p>
                        <pre><code><span class="comment"># Carregar dados</span>
tips = sns.<span class="function">load_dataset</span>(<span class="string">'tips'</span>)
<span class="comment"># Colunas: total_bill, tip, sex, smoker, day, time, size</span>
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns
<span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt

tips = sns.<span class="function">load_dataset</span>(<span class="string">'tips'</span>)
sns.<span class="function">set_theme</span>(style=<span class="string">'whitegrid'</span>)

fig, axes = plt.<span class="function">subplots</span>(<span class="number">2</span>, <span class="number">3</span>, figsize=(<span class="number">15</span>, <span class="number">10</span>))

<span class="comment"># 1. Distribui√ß√£o de gorjetas</span>
sns.<span class="function">histplot</span>(tips, x=<span class="string">'tip'</span>, kde=<span class="keyword">True</span>, ax=axes[<span class="number">0</span>, <span class="number">0</span>])
axes[<span class="number">0</span>, <span class="number">0</span>].<span class="function">set_title</span>(<span class="string">'Distribui√ß√£o de Gorjetas'</span>)

<span class="comment"># 2. Gorjeta vs Conta (com regress√£o)</span>
sns.<span class="function">regplot</span>(tips, x=<span class="string">'total_bill'</span>, y=<span class="string">'tip'</span>, ax=axes[<span class="number">0</span>, <span class="number">1</span>], 
           scatter_kws={<span class="string">'alpha'</span>: <span class="number">0.5</span>})
axes[<span class="number">0</span>, <span class="number">1</span>].<span class="function">set_title</span>(<span class="string">'Gorjeta vs Conta Total'</span>)

<span class="comment"># 3. Box plot por dia</span>
sns.<span class="function">boxplot</span>(tips, x=<span class="string">'day'</span>, y=<span class="string">'tip'</span>, hue=<span class="string">'time'</span>, ax=axes[<span class="number">0</span>, <span class="number">2</span>])
axes[<span class="number">0</span>, <span class="number">2</span>].<span class="function">set_title</span>(<span class="string">'Gorjeta por Dia/Per√≠odo'</span>)

<span class="comment"># 4. Violin por sexo</span>
sns.<span class="function">violinplot</span>(tips, x=<span class="string">'sex'</span>, y=<span class="string">'tip'</span>, hue=<span class="string">'smoker'</span>, 
              split=<span class="keyword">True</span>, ax=axes[<span class="number">1</span>, <span class="number">0</span>])
axes[<span class="number">1</span>, <span class="number">0</span>].<span class="function">set_title</span>(<span class="string">'Gorjeta por Sexo e Fumante'</span>)

<span class="comment"># 5. M√©dia de gorjeta por tamanho da mesa</span>
sns.<span class="function">barplot</span>(tips, x=<span class="string">'size'</span>, y=<span class="string">'tip'</span>, errorbar=<span class="string">'sd'</span>, ax=axes[<span class="number">1</span>, <span class="number">1</span>])
axes[<span class="number">1</span>, <span class="number">1</span>].<span class="function">set_title</span>(<span class="string">'Gorjeta M√©dia por Tamanho'</span>)

<span class="comment"># 6. Heatmap de correla√ß√£o</span>
corr = tips.<span class="function">select_dtypes</span>(<span class="string">'number'</span>).<span class="function">corr</span>()
sns.<span class="function">heatmap</span>(corr, annot=<span class="keyword">True</span>, cmap=<span class="string">'coolwarm'</span>, ax=axes[<span class="number">1</span>, <span class="number">2</span>])
axes[<span class="number">1</span>, <span class="number">2</span>].<span class="function">set_title</span>(<span class="string">'Correla√ß√µes'</span>)

fig.<span class="function">suptitle</span>(<span class="string">'An√°lise do Dataset Tips'</span>, fontsize=<span class="number">14</span>, fontweight=<span class="string">'bold'</span>)
plt.<span class="function">tight_layout</span>()
plt.<span class="function">show</span>()
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4.3 PLOTLY INTERATIVO -->
                <div class="section">
                    <h3>4.3 Plotly: Gr√°ficos Interativos</h3>

                    <p>Plotly cria gr√°ficos interativos para dashboards e apresenta√ß√µes web.</p>

                    <h4>Plotly Express (API Simples)</h4>
                    <pre><code><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px
<span class="keyword">import</span> pandas <span class="keyword">as</span> pd

<span class="comment"># Scatter interativo</span>
fig = px.<span class="function">scatter</span>(df, x=<span class="string">'x'</span>, y=<span class="string">'y'</span>, color=<span class="string">'categoria'</span>,
                  size=<span class="string">'valor'</span>, hover_data=[<span class="string">'nome'</span>])
fig.<span class="function">show</span>()

<span class="comment"># Linha com m√∫ltiplas s√©ries</span>
fig = px.<span class="function">line</span>(df, x=<span class="string">'data'</span>, y=<span class="string">'valor'</span>, color=<span class="string">'categoria'</span>,
               title=<span class="string">'Tend√™ncia por Categoria'</span>)

<span class="comment"># Bar chart animado</span>
fig = px.<span class="function">bar</span>(df, x=<span class="string">'categoria'</span>, y=<span class="string">'valor'</span>, color=<span class="string">'regiao'</span>,
              animation_frame=<span class="string">'ano'</span>, range_y=[<span class="number">0</span>, df[<span class="string">'valor'</span>].<span class="function">max</span>()])

<span class="comment"># Histograma</span>
fig = px.<span class="function">histogram</span>(df, x=<span class="string">'valor'</span>, nbins=<span class="number">50</span>, marginal=<span class="string">'box'</span>)

<span class="comment"># Sunburst (hierarquia)</span>
fig = px.<span class="function">sunburst</span>(df, path=[<span class="string">'regiao'</span>, <span class="string">'estado'</span>, <span class="string">'cidade'</span>], values=<span class="string">'vendas'</span>)
</code></pre>

                    <h4>Mapas</h4>
                    <pre><code><span class="comment"># Mapa de dispers√£o</span>
fig = px.<span class="function">scatter_geo</span>(df, lat=<span class="string">'latitude'</span>, lon=<span class="string">'longitude'</span>,
                      color=<span class="string">'categoria'</span>, size=<span class="string">'valor'</span>,
                      hover_name=<span class="string">'cidade'</span>)

<span class="comment"># Choropleth (mapa de calor geogr√°fico)</span>
fig = px.<span class="function">choropleth</span>(df, locations=<span class="string">'sigla_estado'</span>,
                     locationmode=<span class="string">'USA-states'</span>,  <span class="comment"># ou 'ISO-3' para pa√≠ses</span>
                     color=<span class="string">'valor'</span>,
                     color_continuous_scale=<span class="string">'Viridis'</span>)

<span class="comment"># Mapbox (mais bonito, precisa de token para alguns estilos)</span>
fig = px.<span class="function">scatter_mapbox</span>(df, lat=<span class="string">'lat'</span>, lon=<span class="string">'lon'</span>,
                         color=<span class="string">'categoria'</span>, size=<span class="string">'valor'</span>,
                         mapbox_style=<span class="string">'open-street-map'</span>)
</code></pre>

                    <h4>Customiza√ß√£o e Layouts</h4>
                    <pre><code><span class="comment"># Atualizar layout</span>
fig.<span class="function">update_layout</span>(
    title=<span class="function">dict</span>(text=<span class="string">'T√≠tulo'</span>, font=<span class="function">dict</span>(size=<span class="number">24</span>)),
    template=<span class="string">'plotly_dark'</span>,  <span class="comment"># ou 'ggplot2', 'seaborn'</span>
    showlegend=<span class="keyword">True</span>,
    legend=<span class="function">dict</span>(x=<span class="number">0</span>, y=<span class="number">1</span>),
    margin=<span class="function">dict</span>(l=<span class="number">50</span>, r=<span class="number">50</span>, t=<span class="number">80</span>, b=<span class="number">50</span>)
)

<span class="comment"># Subplots com Plotly</span>
<span class="keyword">from</span> plotly.subplots <span class="keyword">import</span> make_subplots
<span class="keyword">import</span> plotly.graph_objects <span class="keyword">as</span> go

fig = <span class="function">make_subplots</span>(rows=<span class="number">2</span>, cols=<span class="number">2</span>,
                    subplot_titles=[<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>])

fig.<span class="function">add_trace</span>(go.<span class="function">Scatter</span>(x=x, y=y), row=<span class="number">1</span>, col=<span class="number">1</span>)
fig.<span class="function">add_trace</span>(go.<span class="function">Bar</span>(x=cat, y=val), row=<span class="number">1</span>, col=<span class="number">2</span>)

<span class="comment"># Salvar como HTML</span>
fig.<span class="function">write_html</span>(<span class="string">'grafico_interativo.html'</span>)
</code></pre>

                    <div class="note">
                        <strong>Dica:</strong> Plotly funciona nativamente em Jupyter notebooks e pode ser integrado com
                        Dash para criar aplica√ß√µes web completas.
                    </div>

                    <!-- EXERC√çCIO 25 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 25</span>
                            <span class="exercise-title">Dashboard Interativo</span>
                            <span class="difficulty hard">Dif√≠cil</span>
                        </div>
                        <p>Crie um dashboard interativo com Plotly mostrando dados de vendas com anima√ß√£o temporal.</p>
                        <pre><code><span class="comment"># Criar dados sint√©ticos de vendas por m√™s/categoria</span>
<span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

np.random.<span class="function">seed</span>(<span class="number">42</span>)
datas = pd.<span class="function">date_range</span>(<span class="string">'2020-01'</span>, <span class="string">'2023-12'</span>, freq=<span class="string">'MS'</span>)
categorias = [<span class="string">'Eletr√¥nicos'</span>, <span class="string">'Roupas'</span>, <span class="string">'Alimentos'</span>, <span class="string">'M√≥veis'</span>]
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">import</span> plotly.express <span class="keyword">as</span> px
<span class="keyword">from</span> plotly.subplots <span class="keyword">import</span> make_subplots
<span class="keyword">import</span> plotly.graph_objects <span class="keyword">as</span> go
<span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

<span class="comment"># Gerar dados</span>
np.random.<span class="function">seed</span>(<span class="number">42</span>)
datas = pd.<span class="function">date_range</span>(<span class="string">'2020-01'</span>, <span class="string">'2023-12'</span>, freq=<span class="string">'MS'</span>)
categorias = [<span class="string">'Eletr√¥nicos'</span>, <span class="string">'Roupas'</span>, <span class="string">'Alimentos'</span>, <span class="string">'M√≥veis'</span>]

dados = []
<span class="keyword">for</span> data <span class="keyword">in</span> datas:
    <span class="keyword">for</span> cat <span class="keyword">in</span> categorias:
        base = {<span class="string">'Eletr√¥nicos'</span>: <span class="number">1000</span>, <span class="string">'Roupas'</span>: <span class="number">800</span>, 
                <span class="string">'Alimentos'</span>: <span class="number">600</span>, <span class="string">'M√≥veis'</span>: <span class="number">400</span>}[cat]
        tendencia = (data.year - <span class="number">2020</span>) * <span class="number">50</span>
        sazonal = <span class="number">100</span> * np.<span class="function">sin</span>(data.month * np.pi / <span class="number">6</span>)
        valor = base + tendencia + sazonal + np.random.<span class="function">normal</span>(<span class="number">0</span>, <span class="number">50</span>)
        dados.<span class="function">append</span>({<span class="string">'data'</span>: data, <span class="string">'categoria'</span>: cat, <span class="string">'valor'</span>: valor,
                     <span class="string">'ano'</span>: data.year, <span class="string">'mes'</span>: data.month})

df = pd.DataFrame(dados)

<span class="comment"># Criar subplots</span>
fig = <span class="function">make_subplots</span>(
    rows=<span class="number">2</span>, cols=<span class="number">2</span>,
    subplot_titles=[<span class="string">'Tend√™ncia por Categoria'</span>, <span class="string">'Distribui√ß√£o'</span>,
                    <span class="string">'Total por Ano'</span>, <span class="string">'Comparativo Mensal'</span>],
    specs=[[{}, {}], [{}, {}]]
)

cores = px.colors.qualitative.Set2

<span class="comment"># 1. Linha de tend√™ncia</span>
<span class="keyword">for</span> i, cat <span class="keyword">in</span> <span class="function">enumerate</span>(categorias):
    df_cat = df[df[<span class="string">'categoria'</span>] == cat]
    fig.<span class="function">add_trace</span>(
        go.<span class="function">Scatter</span>(x=df_cat[<span class="string">'data'</span>], y=df_cat[<span class="string">'valor'</span>], 
                    name=cat, line=<span class="function">dict</span>(color=cores[i])),
        row=<span class="number">1</span>, col=<span class="number">1</span>
    )

<span class="comment"># 2. Box plot</span>
<span class="keyword">for</span> i, cat <span class="keyword">in</span> <span class="function">enumerate</span>(categorias):
    fig.<span class="function">add_trace</span>(
        go.<span class="function">Box</span>(y=df[df[<span class="string">'categoria'</span>] == cat][<span class="string">'valor'</span>], 
               name=cat, marker_color=cores[i]),
        row=<span class="number">1</span>, col=<span class="number">2</span>
    )

<span class="comment"># 3. Barras por ano</span>
df_ano = df.<span class="function">groupby</span>([<span class="string">'ano'</span>, <span class="string">'categoria'</span>])[<span class="string">'valor'</span>].<span class="function">sum</span>().<span class="function">reset_index</span>()
<span class="keyword">for</span> i, cat <span class="keyword">in</span> <span class="function">enumerate</span>(categorias):
    df_cat = df_ano[df_ano[<span class="string">'categoria'</span>] == cat]
    fig.<span class="function">add_trace</span>(
        go.<span class="function">Bar</span>(x=df_cat[<span class="string">'ano'</span>], y=df_cat[<span class="string">'valor'</span>], 
              name=cat, marker_color=cores[i], showlegend=<span class="keyword">False</span>),
        row=<span class="number">2</span>, col=<span class="number">1</span>
    )

<span class="comment"># 4. Heatmap mensal</span>
pivot = df.<span class="function">pivot_table</span>(values=<span class="string">'valor'</span>, index=<span class="string">'mes'</span>, columns=<span class="string">'categoria'</span>)
fig.<span class="function">add_trace</span>(
    go.<span class="function">Heatmap</span>(z=pivot.values, x=pivot.columns, 
               y=[<span class="string">'Jan'</span>,<span class="string">'Fev'</span>,<span class="string">'Mar'</span>,<span class="string">'Abr'</span>,<span class="string">'Mai'</span>,<span class="string">'Jun'</span>,
                  <span class="string">'Jul'</span>,<span class="string">'Ago'</span>,<span class="string">'Set'</span>,<span class="string">'Out'</span>,<span class="string">'Nov'</span>,<span class="string">'Dez'</span>],
               colorscale=<span class="string">'Viridis'</span>),
    row=<span class="number">2</span>, col=<span class="number">2</span>
)

fig.<span class="function">update_layout</span>(height=<span class="number">700</span>, title_text=<span class="string">'Dashboard de Vendas'</span>,
                  template=<span class="string">'plotly_white'</span>)
fig.<span class="function">show</span>()
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- M√ìDULO 5: MACHINE LEARNING PIPELINE -->
        <div class="module" id="modulo5">
            <div class="module-header">
                <h2>ü§ñ M√≥dulo 5: ML Pipeline</h2>
            </div>
            <div class="module-content">
                <!-- 5.1 SCIKIT-LEARN PIPELINES -->
                <div class="section">
                    <h3>5.1 Pipelines com Scikit-learn</h3>

                    <p>Pipelines encapsulam todo o fluxo de pr√©-processamento e modelagem, evitando data leakage.</p>

                    <h4>Pipeline B√°sico</h4>
                    <pre><code><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline
<span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler
<span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression
<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split

<span class="comment"># Criar pipeline</span>
pipe = <span class="function">Pipeline</span>([
    (<span class="string">'scaler'</span>, <span class="function">StandardScaler</span>()),
    (<span class="string">'classifier'</span>, <span class="function">LogisticRegression</span>())
])

<span class="comment"># Split dos dados</span>
X_train, X_test, y_train, y_test = <span class="function">train_test_split</span>(X, y, test_size=<span class="number">0.2</span>)

<span class="comment"># Treinar (aplica scaler.fit_transform + classifier.fit)</span>
pipe.<span class="function">fit</span>(X_train, y_train)

<span class="comment"># Prever (aplica scaler.transform + classifier.predict)</span>
y_pred = pipe.<span class="function">predict</span>(X_test)
score = pipe.<span class="function">score</span>(X_test, y_test)
</code></pre>

                    <h4>ColumnTransformer (Diferentes Transforma√ß√µes)</h4>
                    <pre><code><span class="keyword">from</span> sklearn.compose <span class="keyword">import</span> ColumnTransformer
<span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler, OneHotEncoder
<span class="keyword">from</span> sklearn.impute <span class="keyword">import</span> SimpleImputer

<span class="comment"># Definir colunas</span>
num_cols = [<span class="string">'idade'</span>, <span class="string">'renda'</span>, <span class="string">'score'</span>]
cat_cols = [<span class="string">'estado'</span>, <span class="string">'categoria'</span>]

<span class="comment"># Pipelines espec√≠ficos para cada tipo</span>
num_pipeline = <span class="function">Pipeline</span>([
    (<span class="string">'imputer'</span>, <span class="function">SimpleImputer</span>(strategy=<span class="string">'median'</span>)),
    (<span class="string">'scaler'</span>, <span class="function">StandardScaler</span>())
])

cat_pipeline = <span class="function">Pipeline</span>([
    (<span class="string">'imputer'</span>, <span class="function">SimpleImputer</span>(strategy=<span class="string">'constant'</span>, fill_value=<span class="string">'missing'</span>)),
    (<span class="string">'encoder'</span>, <span class="function">OneHotEncoder</span>(handle_unknown=<span class="string">'ignore'</span>))
])

<span class="comment"># Combinar transforma√ß√µes</span>
preprocessor = <span class="function">ColumnTransformer</span>([
    (<span class="string">'num'</span>, num_pipeline, num_cols),
    (<span class="string">'cat'</span>, cat_pipeline, cat_cols)
])

<span class="comment"># Pipeline completo</span>
full_pipe = <span class="function">Pipeline</span>([
    (<span class="string">'preprocessor'</span>, preprocessor),
    (<span class="string">'classifier'</span>, <span class="function">LogisticRegression</span>())
])
</code></pre>

                    <h4>GridSearch com Pipeline</h4>
                    <pre><code><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> GridSearchCV

<span class="comment"># Par√¢metros: nome_do_passo__parametro</span>
param_grid = {
    <span class="string">'preprocessor__num__imputer__strategy'</span>: [<span class="string">'mean'</span>, <span class="string">'median'</span>],
    <span class="string">'classifier__C'</span>: [<span class="number">0.1</span>, <span class="number">1</span>, <span class="number">10</span>],
    <span class="string">'classifier__solver'</span>: [<span class="string">'lbfgs'</span>, <span class="string">'liblinear'</span>]
}

grid_search = <span class="function">GridSearchCV</span>(
    full_pipe,
    param_grid,
    cv=<span class="number">5</span>,
    scoring=<span class="string">'roc_auc'</span>,
    n_jobs=-<span class="number">1</span>
)

grid_search.<span class="function">fit</span>(X_train, y_train)

<span class="function">print</span>(<span class="string">f'Melhores params: {grid_search.best_params_}'</span>)
<span class="function">print</span>(<span class="string">f'Melhor score: {grid_search.best_score_:.4f}'</span>)
</code></pre>

                    <div class="tip">
                        <strong>Dica:</strong> Use <code>make_pipeline()</code> para sintaxe mais curta:
                        <code>make_pipeline(StandardScaler(), LogisticRegression())</code>
                    </div>

                    <!-- EXERC√çCIO 26 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 26</span>
                            <span class="exercise-title">Pipeline Completo</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Crie um pipeline completo para classifica√ß√£o com dados mistos (num√©ricos e categ√≥ricos).</p>
                        <pre><code><span class="comment"># Dataset Titanic simplificado</span>
<span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> fetch_openml

titanic = <span class="function">fetch_openml</span>(<span class="string">'titanic'</span>, version=<span class="number">1</span>, as_frame=<span class="keyword">True</span>)
X = titanic.data[[<span class="string">'pclass'</span>, <span class="string">'sex'</span>, <span class="string">'age'</span>, <span class="string">'fare'</span>, <span class="string">'embarked'</span>]]
y = titanic.target
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline
<span class="keyword">from</span> sklearn.compose <span class="keyword">import</span> ColumnTransformer
<span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler, OneHotEncoder
<span class="keyword">from</span> sklearn.impute <span class="keyword">import</span> SimpleImputer
<span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier
<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split, cross_val_score

<span class="comment"># Definir colunas</span>
num_cols = [<span class="string">'age'</span>, <span class="string">'fare'</span>]
cat_cols = [<span class="string">'pclass'</span>, <span class="string">'sex'</span>, <span class="string">'embarked'</span>]

<span class="comment"># Transformadores</span>
num_transformer = <span class="function">Pipeline</span>([
    (<span class="string">'imputer'</span>, <span class="function">SimpleImputer</span>(strategy=<span class="string">'median'</span>)),
    (<span class="string">'scaler'</span>, <span class="function">StandardScaler</span>())
])

cat_transformer = <span class="function">Pipeline</span>([
    (<span class="string">'imputer'</span>, <span class="function">SimpleImputer</span>(strategy=<span class="string">'most_frequent'</span>)),
    (<span class="string">'encoder'</span>, <span class="function">OneHotEncoder</span>(handle_unknown=<span class="string">'ignore'</span>))
])

preprocessor = <span class="function">ColumnTransformer</span>([
    (<span class="string">'num'</span>, num_transformer, num_cols),
    (<span class="string">'cat'</span>, cat_transformer, cat_cols)
])

<span class="comment"># Pipeline final</span>
pipe = <span class="function">Pipeline</span>([
    (<span class="string">'preprocessor'</span>, preprocessor),
    (<span class="string">'classifier'</span>, <span class="function">RandomForestClassifier</span>(n_estimators=<span class="number">100</span>, random_state=<span class="number">42</span>))
])

<span class="comment"># Treinar e avaliar</span>
X_train, X_test, y_train, y_test = <span class="function">train_test_split</span>(X, y, test_size=<span class="number">0.2</span>)

<span class="comment"># Cross-validation</span>
scores = <span class="function">cross_val_score</span>(pipe, X_train, y_train, cv=<span class="number">5</span>, scoring=<span class="string">'accuracy'</span>)
<span class="function">print</span>(<span class="string">f'CV Accuracy: {scores.mean():.3f} (+/- {scores.std():.3f})'</span>)

<span class="comment"># Treinar modelo final</span>
pipe.<span class="function">fit</span>(X_train, y_train)
<span class="function">print</span>(<span class="string">f'Test Accuracy: {pipe.score(X_test, y_test):.3f}'</span>)
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5.2 FEATURE ENGINEERING -->
                <div class="section">
                    <h3>5.2 Feature Engineering</h3>

                    <p>Criar boas features √© frequentemente mais impactante que escolher o modelo certo.</p>

                    <h4>Transformadores Customizados</h4>
                    <pre><code><span class="keyword">from</span> sklearn.base <span class="keyword">import</span> BaseEstimator, TransformerMixin

<span class="keyword">class</span> <span class="function">DateFeatures</span>(BaseEstimator, TransformerMixin):
    <span class="string">"""Extrai features de colunas de data"""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(self, date_col):
        self.date_col = date_col
    
    <span class="keyword">def</span> <span class="function">fit</span>(self, X, y=<span class="keyword">None</span>):
        <span class="keyword">return</span> self
    
    <span class="keyword">def</span> <span class="function">transform</span>(self, X):
        X = X.<span class="function">copy</span>()
        X[<span class="string">'ano'</span>] = X[self.date_col].dt.year
        X[<span class="string">'mes'</span>] = X[self.date_col].dt.month
        X[<span class="string">'dia_semana'</span>] = X[self.date_col].dt.dayofweek
        X[<span class="string">'is_weekend'</span>] = X[<span class="string">'dia_semana'</span>] >= <span class="number">5</span>
        <span class="keyword">return</span> X.<span class="function">drop</span>(columns=[self.date_col])

<span class="comment"># Uso em pipeline</span>
pipe = <span class="function">Pipeline</span>([
    (<span class="string">'date_features'</span>, <span class="function">DateFeatures</span>(<span class="string">'data'</span>)),
    (<span class="string">'scaler'</span>, <span class="function">StandardScaler</span>()),
    (<span class="string">'model'</span>, <span class="function">RandomForestRegressor</span>())
])
</code></pre>

                    <h4>PolynomialFeatures e Intera√ß√µes</h4>
                    <pre><code><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> PolynomialFeatures

<span class="comment"># Criar features polinomiais e intera√ß√µes</span>
poly = <span class="function">PolynomialFeatures</span>(degree=<span class="number">2</span>, include_bias=<span class="keyword">False</span>, interaction_only=<span class="keyword">False</span>)
X_poly = poly.<span class="function">fit_transform</span>(X)

<span class="comment"># Ver nomes das features</span>
<span class="function">print</span>(poly.<span class="function">get_feature_names_out</span>())
<span class="comment"># ['x0', 'x1', 'x0^2', 'x0 x1', 'x1^2']</span>

<span class="comment"># S√≥ intera√ß√µes (sem quadrados)</span>
poly_int = <span class="function">PolynomialFeatures</span>(degree=<span class="number">2</span>, interaction_only=<span class="keyword">True</span>)
</code></pre>

                    <h4>Feature Selection</h4>
                    <pre><code><span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> (
    SelectKBest, f_classif, RFE, SelectFromModel
)
<span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier

<span class="comment"># 1. Teste estat√≠stico (top K features)</span>
selector = <span class="function">SelectKBest</span>(f_classif, k=<span class="number">10</span>)
X_selected = selector.<span class="function">fit_transform</span>(X, y)

<span class="comment"># 2. Recursive Feature Elimination</span>
rfe = <span class="function">RFE</span>(
    estimator=<span class="function">RandomForestClassifier</span>(),
    n_features_to_select=<span class="number">10</span>,
    step=<span class="number">1</span>
)
X_rfe = rfe.<span class="function">fit_transform</span>(X, y)

<span class="comment"># 3. Baseado em import√¢ncia do modelo</span>
sfm = <span class="function">SelectFromModel</span>(
    <span class="function">RandomForestClassifier</span>(),
    threshold=<span class="string">'median'</span>  <span class="comment"># ou valor num√©rico</span>
)
X_sfm = sfm.<span class="function">fit_transform</span>(X, y)

<span class="comment"># Integrar no pipeline</span>
pipe = <span class="function">Pipeline</span>([
    (<span class="string">'scaler'</span>, <span class="function">StandardScaler</span>()),
    (<span class="string">'selector'</span>, <span class="function">SelectKBest</span>(f_classif, k=<span class="number">20</span>)),
    (<span class="string">'model'</span>, <span class="function">LogisticRegression</span>())
])
</code></pre>

                    <!-- EXERC√çCIO 27 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 27</span>
                            <span class="exercise-title">Transformador Customizado</span>
                            <span class="difficulty medium">M√©dio</span>
                        </div>
                        <p>Crie um transformador que gere features de texto (comprimento, contagem de palavras, presen√ßa
                            de caracteres especiais).</p>
                        <pre><code><span class="comment"># Dados de exemplo</span>
textos = pd.DataFrame({
    <span class="string">'texto'</span>: [<span class="string">'Ol√° mundo!'</span>, <span class="string">'Python √© incr√≠vel.'</span>, <span class="string">'ML #$@!'</span>]
})
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">from</span> sklearn.base <span class="keyword">import</span> BaseEstimator, TransformerMixin
<span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> re

<span class="keyword">class</span> <span class="function">TextFeatures</span>(BaseEstimator, TransformerMixin):
    <span class="string">"""Extrai features estat√≠sticas de texto"""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(self, text_col):
        self.text_col = text_col
    
    <span class="keyword">def</span> <span class="function">fit</span>(self, X, y=<span class="keyword">None</span>):
        <span class="keyword">return</span> self
    
    <span class="keyword">def</span> <span class="function">transform</span>(self, X):
        X = X.<span class="function">copy</span>()
        texto = X[self.text_col].<span class="function">fillna</span>(<span class="string">''</span>)
        
        <span class="comment"># Features b√°sicas</span>
        X[<span class="string">'len_chars'</span>] = texto.<span class="function">str.len</span>()
        X[<span class="string">'n_words'</span>] = texto.<span class="function">str.split</span>().<span class="function">str.len</span>()
        X[<span class="string">'avg_word_len'</span>] = X[<span class="string">'len_chars'</span>] / X[<span class="string">'n_words'</span>].<span class="function">replace</span>(<span class="number">0</span>, <span class="number">1</span>)
        
        <span class="comment"># Caracteres especiais</span>
        X[<span class="string">'n_special'</span>] = texto.<span class="function">apply</span>(<span class="keyword">lambda</span> x: <span class="function">len</span>(re.<span class="function">findall</span>(<span class="string">r'[!@#$%^&*()]'</span>, x)))
        X[<span class="string">'has_special'</span>] = (X[<span class="string">'n_special'</span>] > <span class="number">0</span>).<span class="function">astype</span>(<span class="function">int</span>)
        
        <span class="comment"># Mai√∫sculas</span>
        X[<span class="string">'n_upper'</span>] = texto.<span class="function">str.count</span>(<span class="string">r'[A-Z]'</span>)
        X[<span class="string">'pct_upper'</span>] = X[<span class="string">'n_upper'</span>] / X[<span class="string">'len_chars'</span>].<span class="function">replace</span>(<span class="number">0</span>, <span class="number">1</span>)
        
        <span class="keyword">return</span> X.<span class="function">drop</span>(columns=[self.text_col])

<span class="comment"># Testar</span>
tf = <span class="function">TextFeatures</span>(<span class="string">'texto'</span>)
result = tf.<span class="function">fit_transform</span>(textos)
<span class="function">print</span>(result)
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5.3 MODEL EVALUATION -->
                <div class="section">
                    <h3>5.3 Avalia√ß√£o de Modelos</h3>

                    <p>Escolha m√©tricas que fa√ßam sentido para o problema de neg√≥cio.</p>

                    <h4>M√©tricas de Classifica√ß√£o</h4>
                    <pre><code><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> (
    accuracy_score, precision_score, recall_score, f1_score,
    classification_report, confusion_matrix, roc_auc_score, roc_curve
)

<span class="comment"># Relat√≥rio completo</span>
<span class="function">print</span>(<span class="function">classification_report</span>(y_test, y_pred))

<span class="comment"># M√©tricas individuais</span>
accuracy = <span class="function">accuracy_score</span>(y_test, y_pred)
precision = <span class="function">precision_score</span>(y_test, y_pred, average=<span class="string">'weighted'</span>)
recall = <span class="function">recall_score</span>(y_test, y_pred, average=<span class="string">'weighted'</span>)
f1 = <span class="function">f1_score</span>(y_test, y_pred, average=<span class="string">'weighted'</span>)

<span class="comment"># ROC AUC (para probabilidades)</span>
y_proba = model.<span class="function">predict_proba</span>(X_test)[:, <span class="number">1</span>]
roc_auc = <span class="function">roc_auc_score</span>(y_test, y_proba)

<span class="comment"># Curva ROC</span>
fpr, tpr, thresholds = <span class="function">roc_curve</span>(y_test, y_proba)
</code></pre>

                    <h4>M√©tricas de Regress√£o</h4>
                    <pre><code><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> (
    mean_squared_error, mean_absolute_error, r2_score,
    mean_absolute_percentage_error
)

mse = <span class="function">mean_squared_error</span>(y_test, y_pred)
rmse = <span class="function">mean_squared_error</span>(y_test, y_pred, squared=<span class="keyword">False</span>)
mae = <span class="function">mean_absolute_error</span>(y_test, y_pred)
mape = <span class="function">mean_absolute_percentage_error</span>(y_test, y_pred)
r2 = <span class="function">r2_score</span>(y_test, y_pred)

<span class="function">print</span>(<span class="string">f'RMSE: {rmse:.2f}'</span>)
<span class="function">print</span>(<span class="string">f'MAE: {mae:.2f}'</span>)
<span class="function">print</span>(<span class="string">f'MAPE: {mape:.2%}'</span>)
<span class="function">print</span>(<span class="string">f'R¬≤: {r2:.4f}'</span>)
</code></pre>

                    <h4>Valida√ß√£o Cruzada Avan√ßada</h4>
                    <pre><code><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> (
    cross_val_score, cross_validate, StratifiedKFold, TimeSeriesSplit
)

<span class="comment"># Cross-validation b√°sica</span>
scores = <span class="function">cross_val_score</span>(model, X, y, cv=<span class="number">5</span>, scoring=<span class="string">'accuracy'</span>)

<span class="comment"># M√∫ltiplas m√©tricas</span>
scoring = [<span class="string">'accuracy'</span>, <span class="string">'precision'</span>, <span class="string">'recall'</span>, <span class="string">'f1'</span>]
cv_results = <span class="function">cross_validate</span>(model, X, y, cv=<span class="number">5</span>, scoring=scoring)
<span class="keyword">for</span> metric <span class="keyword">in</span> scoring:
    <span class="function">print</span>(<span class="string">f'{metric}: {cv_results[f"test_{metric}"].mean():.3f}'</span>)

<span class="comment"># Stratified para classifica√ß√£o desbalanceada</span>
skf = <span class="function">StratifiedKFold</span>(n_splits=<span class="number">5</span>, shuffle=<span class="keyword">True</span>, random_state=<span class="number">42</span>)
scores = <span class="function">cross_val_score</span>(model, X, y, cv=skf)

<span class="comment"># Time Series Split (nunca usar futuro para prever passado!)</span>
tscv = <span class="function">TimeSeriesSplit</span>(n_splits=<span class="number">5</span>)
scores = <span class="function">cross_val_score</span>(model, X, y, cv=tscv)
</code></pre>

                    <div class="note">
                        <strong>Importante:</strong> Para dados desequilibrados, accuracy √© enganosa. Prefira F1, PR-AUC
                        ou m√©tricas focadas na classe minorit√°ria.
                    </div>

                    <!-- EXERC√çCIO 28 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 28</span>
                            <span class="exercise-title">Compara√ß√£o de Modelos</span>
                            <span class="difficulty hard">Dif√≠cil</span>
                        </div>
                        <p>Compare m√∫ltiplos modelos usando cross-validation e visualize os resultados.</p>
                        <pre><code><span class="comment"># Modelos a comparar</span>
<span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression
<span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier, GradientBoostingClassifier
<span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt
<span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> make_classification
<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_validate, StratifiedKFold
<span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression
<span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier, GradientBoostingClassifier
<span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC
<span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler
<span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> make_pipeline

<span class="comment"># Criar dataset</span>
X, y = <span class="function">make_classification</span>(n_samples=<span class="number">1000</span>, n_features=<span class="number">20</span>, 
                            n_informative=<span class="number">15</span>, random_state=<span class="number">42</span>)

<span class="comment"># Modelos</span>
models = {
    <span class="string">'Logistic Regression'</span>: <span class="function">make_pipeline</span>(<span class="function">StandardScaler</span>(), <span class="function">LogisticRegression</span>()),
    <span class="string">'Random Forest'</span>: <span class="function">RandomForestClassifier</span>(n_estimators=<span class="number">100</span>),
    <span class="string">'Gradient Boosting'</span>: <span class="function">GradientBoostingClassifier</span>(),
    <span class="string">'SVM'</span>: <span class="function">make_pipeline</span>(<span class="function">StandardScaler</span>(), <span class="function">SVC</span>(probability=<span class="keyword">True</span>))
}

<span class="comment"># Avaliar</span>
scoring = [<span class="string">'accuracy'</span>, <span class="string">'f1'</span>, <span class="string">'roc_auc'</span>]
cv = <span class="function">StratifiedKFold</span>(n_splits=<span class="number">5</span>, shuffle=<span class="keyword">True</span>, random_state=<span class="number">42</span>)

results = {}
<span class="keyword">for</span> name, model <span class="keyword">in</span> models.<span class="function">items</span>():
    cv_results = <span class="function">cross_validate</span>(model, X, y, cv=cv, scoring=scoring)
    results[name] = {
        <span class="string">'accuracy'</span>: cv_results[<span class="string">'test_accuracy'</span>].<span class="function">mean</span>(),
        <span class="string">'f1'</span>: cv_results[<span class="string">'test_f1'</span>].<span class="function">mean</span>(),
        <span class="string">'roc_auc'</span>: cv_results[<span class="string">'test_roc_auc'</span>].<span class="function">mean</span>(),
        <span class="string">'fit_time'</span>: cv_results[<span class="string">'fit_time'</span>].<span class="function">mean</span>()
    }
    <span class="function">print</span>(<span class="string">f'{name}: Acc={results[name]["accuracy"]:.3f}, '</span>
          <span class="string">f'F1={results[name]["f1"]:.3f}, AUC={results[name]["roc_auc"]:.3f}'</span>)

<span class="comment"># Visualizar</span>
df_results = pd.<span class="function">DataFrame</span>(results).T
fig, axes = plt.<span class="function">subplots</span>(<span class="number">1</span>, <span class="number">3</span>, figsize=(<span class="number">12</span>, <span class="number">4</span>))

<span class="keyword">for</span> i, metric <span class="keyword">in</span> <span class="function">enumerate</span>([<span class="string">'accuracy'</span>, <span class="string">'f1'</span>, <span class="string">'roc_auc'</span>]):
    df_results[metric].<span class="function">plot</span>(kind=<span class="string">'barh'</span>, ax=axes[i], color=<span class="string">'#3498db'</span>)
    axes[i].<span class="function">set_title</span>(metric.<span class="function">upper</span>())
    axes[i].<span class="function">set_xlim</span>(<span class="number">0.7</span>, <span class="number">1</span>)

plt.<span class="function">tight_layout</span>()
plt.<span class="function">show</span>()
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5.4 MLOps B√ÅSICO -->
                <div class="section">
                    <h3>5.4 MLOps B√°sico</h3>

                    <p>Preparando modelos para produ√ß√£o: serializa√ß√£o, versionamento e monitoramento.</p>

                    <h4>Salvando e Carregando Modelos</h4>
                    <pre><code><span class="keyword">import</span> joblib
<span class="keyword">import</span> pickle

<span class="comment"># M√©todo 1: joblib (recomendado para sklearn)</span>
joblib.<span class="function">dump</span>(pipeline, <span class="string">'model.joblib'</span>)
pipeline_loaded = joblib.<span class="function">load</span>(<span class="string">'model.joblib'</span>)

<span class="comment"># M√©todo 2: pickle</span>
<span class="keyword">with</span> <span class="function">open</span>(<span class="string">'model.pkl'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:
    pickle.<span class="function">dump</span>(pipeline, f)

<span class="keyword">with</span> <span class="function">open</span>(<span class="string">'model.pkl'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:
    pipeline_loaded = pickle.<span class="function">load</span>(f)

<span class="comment"># Salvar metadados junto</span>
model_artifact = {
    <span class="string">'model'</span>: pipeline,
    <span class="string">'feature_names'</span>: feature_names,
    <span class="string">'version'</span>: <span class="string">'1.0.0'</span>,
    <span class="string">'trained_at'</span>: <span class="string">'2024-01-01'</span>,
    <span class="string">'metrics'</span>: {<span class="string">'accuracy'</span>: <span class="number">0.92</span>, <span class="string">'f1'</span>: <span class="number">0.89</span>}
}
joblib.<span class="function">dump</span>(model_artifact, <span class="string">'model_v1.0.0.joblib'</span>)
</code></pre>

                    <h4>Fun√ß√£o de Predi√ß√£o para API</h4>
                    <pre><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> joblib

<span class="keyword">class</span> <span class="function">ModelPredictor</span>:
    <span class="string">"""Wrapper para servir modelo em produ√ß√£o"""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(self, model_path):
        artifact = joblib.<span class="function">load</span>(model_path)
        self.model = artifact[<span class="string">'model'</span>]
        self.feature_names = artifact[<span class="string">'feature_names'</span>]
        self.version = artifact[<span class="string">'version'</span>]
    
    <span class="keyword">def</span> <span class="function">predict</span>(self, data: <span class="function">dict</span>) -> <span class="function">dict</span>:
        <span class="string">"""Recebe dict, retorna predi√ß√£o"""</span>
        df = pd.<span class="function">DataFrame</span>([data])
        
        <span class="comment"># Validar features</span>
        missing = <span class="function">set</span>(self.feature_names) - <span class="function">set</span>(df.columns)
        <span class="keyword">if</span> missing:
            <span class="keyword">raise</span> <span class="function">ValueError</span>(<span class="string">f'Missing features: {missing}'</span>)
        
        <span class="comment"># Predi√ß√£o</span>
        pred = self.model.<span class="function">predict</span>(df)[<span class="number">0</span>]
        proba = self.model.<span class="function">predict_proba</span>(df)[<span class="number">0</span>].<span class="function">max</span>()
        
        <span class="keyword">return</span> {
            <span class="string">'prediction'</span>: <span class="function">int</span>(pred),
            <span class="string">'confidence'</span>: <span class="function">float</span>(proba),
            <span class="string">'model_version'</span>: self.version
        }

<span class="comment"># Uso</span>
predictor = <span class="function">ModelPredictor</span>(<span class="string">'model_v1.0.0.joblib'</span>)
result = predictor.<span class="function">predict</span>({<span class="string">'age'</span>: <span class="number">30</span>, <span class="string">'fare'</span>: <span class="number">50</span>, <span class="string">'pclass'</span>: <span class="number">2</span>})
</code></pre>

                    <div class="tip">
                        <strong>Pr√≥ximos passos:</strong> Para MLOps completo, explore MLflow, DVC, Weights & Biases, e
                        frameworks como FastAPI para servir modelos.
                    </div>

                    <!-- EXERC√çCIO 29 -->
                    <div class="exercise">
                        <div class="exercise-header">
                            <span class="exercise-badge">Exerc√≠cio 29</span>
                            <span class="exercise-title">Pipeline End-to-End</span>
                            <span class="difficulty hard">Dif√≠cil</span>
                        </div>
                        <p>Crie um pipeline completo: treino, avalia√ß√£o, salvamento do modelo com metadados, e fun√ß√£o de
                            infer√™ncia.</p>
                        <pre><code><span class="comment"># Requisitos:</span>
<span class="comment"># 1. Carregar dados (pode usar make_classification)</span>
<span class="comment"># 2. Criar pipeline com pr√©-processamento</span>
<span class="comment"># 3. Busca de hiperpar√¢metros com GridSearch</span>
<span class="comment"># 4. Avaliar com m√∫ltiplas m√©tricas</span>
<span class="comment"># 5. Salvar modelo com metadados</span>
<span class="comment"># 6. Criar classe de predi√ß√£o</span>
</code></pre>
                        <div class="solution">
                            <button class="solution-toggle" onclick="toggleSolution(this)">üîì Ver Solu√ß√£o</button>
                            <div class="solution-content">
                                <pre><code><span class="keyword">import</span> joblib
<span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> numpy <span class="keyword">as</span> np
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime
<span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> make_classification
<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split, GridSearchCV
<span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline
<span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler
<span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier
<span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> classification_report, roc_auc_score

<span class="comment"># 1. Dados</span>
X, y = <span class="function">make_classification</span>(n_samples=<span class="number">1000</span>, n_features=<span class="number">10</span>, random_state=<span class="number">42</span>)
feature_names = [<span class="string">f'feature_{i}'</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="function">range</span>(<span class="number">10</span>)]
X = pd.<span class="function">DataFrame</span>(X, columns=feature_names)
X_train, X_test, y_train, y_test = <span class="function">train_test_split</span>(X, y, test_size=<span class="number">0.2</span>)

<span class="comment"># 2. Pipeline</span>
pipe = <span class="function">Pipeline</span>([
    (<span class="string">'scaler'</span>, <span class="function">StandardScaler</span>()),
    (<span class="string">'rf'</span>, <span class="function">RandomForestClassifier</span>(random_state=<span class="number">42</span>))
])

<span class="comment"># 3. GridSearch</span>
param_grid = {
    <span class="string">'rf__n_estimators'</span>: [<span class="number">50</span>, <span class="number">100</span>],
    <span class="string">'rf__max_depth'</span>: [<span class="number">5</span>, <span class="number">10</span>, <span class="keyword">None</span>]
}

grid = <span class="function">GridSearchCV</span>(pipe, param_grid, cv=<span class="number">5</span>, scoring=<span class="string">'roc_auc'</span>, n_jobs=-<span class="number">1</span>)
grid.<span class="function">fit</span>(X_train, y_train)

<span class="function">print</span>(<span class="string">f'Best params: {grid.best_params_}'</span>)
<span class="function">print</span>(<span class="string">f'Best CV score: {grid.best_score_:.4f}'</span>)

<span class="comment"># 4. Avaliar</span>
best_model = grid.best_estimator_
y_pred = best_model.<span class="function">predict</span>(X_test)
y_proba = best_model.<span class="function">predict_proba</span>(X_test)[:, <span class="number">1</span>]

<span class="function">print</span>(<span class="function">classification_report</span>(y_test, y_pred))
test_auc = <span class="function">roc_auc_score</span>(y_test, y_proba)
<span class="function">print</span>(<span class="string">f'Test AUC: {test_auc:.4f}'</span>)

<span class="comment"># 5. Salvar com metadados</span>
artifact = {
    <span class="string">'model'</span>: best_model,
    <span class="string">'feature_names'</span>: feature_names,
    <span class="string">'version'</span>: <span class="string">'1.0.0'</span>,
    <span class="string">'trained_at'</span>: datetime.<span class="function">now</span>().<span class="function">isoformat</span>(),
    <span class="string">'best_params'</span>: grid.best_params_,
    <span class="string">'metrics'</span>: {<span class="string">'cv_auc'</span>: grid.best_score_, <span class="string">'test_auc'</span>: test_auc}
}
joblib.<span class="function">dump</span>(artifact, <span class="string">'model_v1.0.0.joblib'</span>)

<span class="comment"># 6. Classe de predi√ß√£o</span>
<span class="keyword">class</span> <span class="function">MLPredictor</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self, path):
        artifact = joblib.<span class="function">load</span>(path)
        self.model = artifact[<span class="string">'model'</span>]
        self.features = artifact[<span class="string">'feature_names'</span>]
        self.version = artifact[<span class="string">'version'</span>]
    
    <span class="keyword">def</span> <span class="function">predict</span>(self, data):
        df = pd.<span class="function">DataFrame</span>([data])[self.features]
        pred = self.model.<span class="function">predict</span>(df)[<span class="number">0</span>]
        proba = self.model.<span class="function">predict_proba</span>(df)[<span class="number">0</span>].<span class="function">tolist</span>()
        <span class="keyword">return</span> {<span class="string">'class'</span>: <span class="function">int</span>(pred), <span class="string">'probas'</span>: proba, <span class="string">'version'</span>: self.version}

<span class="comment"># Testar</span>
predictor = <span class="function">MLPredictor</span>(<span class="string">'model_v1.0.0.joblib'</span>)
sample = {f: np.random.<span class="function">randn</span>() <span class="keyword">for</span> f <span class="keyword">in</span> feature_names}
<span class="function">print</span>(predictor.<span class="function">predict</span>(sample))
</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Python Avan√ßado para Data Science ‚Ä¢ 2026</p>
    </footer>

    <script>
        // Toggle solution visibility
        function toggleSolution(btn) {
            const content = btn.nextElementSibling;
            content.classList.toggle('show');
            btn.textContent = content.classList.contains('show') ? 'üîí Ocultar Solu√ß√£o' : 'üîì Ver Solu√ß√£o';
        }

        // Active nav link
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', function () {
                document.querySelectorAll('nav a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });
    </script>
</body>

</html>